<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>Free</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/rip.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="common/slides.js"></script>
<link href="common/css/slides.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 7: Reasoning about Interactive Programs</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">Free</h1>


<div class="doc">
<a id="lab211"></a><h2 class="section">Extensible Semantics and the <span class="inlinecode"><span class="id" title="var">Free</span></span> Monad</h2>

</div>

<div class="doc">
<a id="lab212"></a><h3 class="section">A toy expression language AST</h3>

</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Expr</span> : <span class="id" title="keyword">Set</span> :=<br/>
| <span class="id" title="var">Val</span> (<span class="id" title="var">n</span> : <span class="id" title="var">nat</span>)<br/>
| <span class="id" title="keyword">Add</span> (<span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> : <span class="id" title="var">Expr</span>).<br/>
</div>

<div class="doc">
Its evaluation function: 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="tactic">eval</span> (<span class="id" title="var">e</span> : <span class="id" title="var">Expr</span>) : <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Val</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" title="keyword">Add</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <span class="id" title="tactic">eval</span> <span class="id" title="var">e<sub>1</sub></span> + <span class="id" title="tactic">eval</span> <span class="id" title="var">e<sub>2</sub></span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <span class="id" title="var">e</span> : <span class="id" title="var">Expr</span> := <span class="id" title="keyword">Add</span> (<span class="id" title="var">Val</span> 3) (<span class="id" title="var">Val</span> 4).<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="tactic">eval</span> <span class="id" title="var">e</span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab213"></a><h3 class="section">The expression problem</h3>

<div class="paragraph"> </div>

 Consider adding a new operation: 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Expr'</span> : <span class="id" title="keyword">Set</span> :=<br/>
| <span class="id" title="var">Val'</span> (<span class="id" title="var">n</span> : <span class="id" title="var">nat</span>)<br/>
| <span class="id" title="var">Add'</span> (<span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> : <span class="id" title="var">Expr'</span>)<br/>
| <span class="id" title="var">Minus'</span> (<span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> : <span class="id" title="var">Expr'</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">eval'</span> (<span class="id" title="var">e</span> : <span class="id" title="var">Expr'</span>) : <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Val'</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Add'</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <span class="id" title="var">eval'</span> <span class="id" title="var">e<sub>1</sub></span> + <span class="id" title="var">eval'</span> <span class="id" title="var">e<sub>2</sub></span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Minus'</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <span class="id" title="var">eval'</span> <span class="id" title="var">e<sub>1</sub></span> - <span class="id" title="var">eval'</span> <span class="id" title="var">e<sub>2</sub></span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <span class="id" title="var">e'</span> : <span class="id" title="var">Expr'</span> := <span class="id" title="var">Minus'</span> (<span class="id" title="var">Val'</span> 7) (<span class="id" title="var">Val'</span> 4).<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">eval'</span> <span class="id" title="var">e'</span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">3</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 This works, but isn't very extensible. 
</div>

<div class="doc">
<a id="lab214"></a><h3 class="section">One solution (Datatypes à la carte)</h3>

<div class="paragraph"> </div>

 Add a parameter so <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode"><span class="id" title="var">Op</span></span> is now either
<ul class="doclist">
<li> a value, or,

</li>
<li> a computation that first performs an <span class="inlinecode"><span class="id" title="var">Op</span></span>, and then builds a new expression indexed by a natural number.

</li>
</ul>

<div class="paragraph"> </div>

  In the latter case, we think of the index provided to continuation <span class="inlinecode"><span class="id" title="var">k</span></span> as the result of computing <span class="inlinecode"><span class="id" title="var">op</span></span>.

<div class="paragraph"> </div>

 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Expr</span> (<span class="id" title="var">Op</span> : <span class="id" title="keyword">Type</span>) :=<br/>
| <span class="id" title="var">Val</span> (<span class="id" title="var">n</span> : <span class="id" title="var">nat</span>)<br/>
| <span class="id" title="var">Do</span> (<span class="id" title="var">op</span> : <span class="id" title="var">Op</span>) (<span class="id" title="var">k</span> : <span class="id" title="var">nat</span> → <span class="id" title="var">Expr</span> <span class="id" title="var">Op</span>).<br/>
</div>

<div class="doc">
<a id="lab215"></a><h3 class="section">Instantiating <span class="inlinecode"><span class="id" title="var">Op</span></span></h3>

<div class="paragraph"> </div>

 Now define <span class="inlinecode"><span class="id" title="var">Plus</span></span> like this, which extends the <i>syntax</i> of <span class="inlinecode"><span class="id" title="var">Expr</span></span>: 
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Plus</span> := <span class="id" title="var">add</span> (<span class="id" title="var">n<sub>1</sub></span> <span class="id" title="var">n<sub>2</sub></span> : <span class="id" title="var">nat</span>).<br/>
</div>

<div class="doc">
It looks a bit weird, but we can write the <span class="inlinecode"><span class="id" title="var">Expr</span></span> summing 3 and 4 and
returning the result as follows:  
</div>
<div class="code">
<span class="id" title="keyword">Example</span> <span class="id" title="var">e</span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Plus</span> := <span class="id" title="var">Do</span> (<span class="id" title="var">add</span> 3 4) (<span class="id" title="keyword">fun</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">Val</span> <span class="id" title="var">n</span>).<br/>
</div>

<div class="doc">
<a id="lab216"></a><h3 class="section">A naive interpreter</h3>

<div class="paragraph"> </div>

 The next thing we wanted to do is to define an evaluation function. We could
do it directly: 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">eval_naive</span> (<span class="id" title="var">t</span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Plus</span>) : <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Val</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Do</span> (<span class="id" title="var">add</span> <span class="id" title="var">n</span> <span class="id" title="var">m</span>) <span class="id" title="var">k</span> ⇒ <span class="id" title="var">eval_naive</span> (<span class="id" title="var">k</span> (<span class="id" title="var">n</span> + <span class="id" title="var">m</span>))<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<span class="id" title="var">eval_naive</span> <span class="id" title="var">e</span>).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 But if we did that, we would have a weirder syntax, and gained nothing. 
<div class="paragraph"> </div>

<a id="lab217"></a><h3 class="section">A better way:</h3>
 Parameterize the evaluator by a <i>handler</i> <span class="inlinecode"><span class="id" title="var">h</span></span>. 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">fold_eval</span> {<span class="id" title="var">Op</span>} (<span class="id" title="var">h</span> : <span class="id" title="var">Op</span> → <span class="id" title="var">nat</span>) (<span class="id" title="var">t</span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Op</span>) : <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Val</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">k</span> ⇒ <span class="id" title="var">fold_eval</span> <span class="id" title="var">h</span> (<span class="id" title="var">k</span> (<span class="id" title="var">h</span> <span class="id" title="var">op</span>))<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
A <i>handler</i> for <span class="inlinecode"><span class="id" title="var">Plus</span></span>: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">hplus</span> : <span class="id" title="var">Plus</span> → <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> '(<span class="id" title="var">add</span> <span class="id" title="var">n<sub>1</sub></span> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <span class="id" title="var">n<sub>1</sub></span> + <span class="id" title="var">n<sub>2</sub></span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">evalp</span> := <span class="id" title="var">fold_eval</span> <span class="id" title="var">hplus</span>.<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">evalp</span> <span class="id" title="var">e</span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab218"></a><h3 class="section">Sequential composition</h3>

</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">seq</span> {<span class="id" title="var">Op</span>} (<span class="id" title="var">e</span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Op</span>) (<span class="id" title="var">k</span> : <span class="id" title="var">nat</span> → <span class="id" title="var">Expr</span> <span class="id" title="var">Op</span>) : <span class="id" title="var">Expr</span> <span class="id" title="var">Op</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Val</span> <span class="id" title="var">n</span>   ⇒ <span class="id" title="var">k</span> <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">h</span> ⇒ <span class="id" title="var">Do</span> <span class="id" title="var">op</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">seq</span> (<span class="id" title="var">h</span> <span class="id" title="var">n</span>) <span class="id" title="var">k</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> &quot;x &lt;- t<sub>1</sub> ;; t<sub>2</sub>" := (<span class="id" title="var">seq</span> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">t<sub>2</sub></span>))<br/>
</div>

<div class="doc">
(Not quite a monad yet, it is too specific.) 
<div class="paragraph"> </div>

<a id="lab219"></a><h3 class="section">Operations as "triggerable" events.</h3>

<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">trigger</span></span> <span class="inlinecode"><span class="id" title="var">op</span></span> does <span class="inlinecode"><span class="id" title="var">op</span></span> and returns its value. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">trigger</span> {<span class="id" title="var">Op</span>} (<span class="id" title="var">op</span> : <span class="id" title="var">Op</span>): <span class="id" title="var">Expr</span> <span class="id" title="var">Op</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">Do</span> <span class="id" title="var">op</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">Val</span> <span class="id" title="var">x</span>).<br/>
</div>

<div class="doc">
<a id="lab220"></a><h3 class="section"> </h3>

<div class="paragraph"> </div>

 With this, we can already write examples a bit more comfortably: 
</div>
<div class="code">
<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>1</sub></span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Plus</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> 3 4).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">evalp</span> <span class="id" title="var">e<sub>1</sub></span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab221"></a><h3 class="section"> </h3>

</div>
<div class="code">

<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>2</sub></span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Plus</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> 1 2);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> 3 4);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> <span class="id" title="var">x</span> <span class="id" title="var">y</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">evalp</span> <span class="id" title="var">e<sub>2</sub></span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">10</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab222"></a><h3 class="section">Adding another operation</h3>

</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Minus</span> := <span class="id" title="var">sub</span> (<span class="id" title="var">n<sub>1</sub></span> <span class="id" title="var">n<sub>2</sub></span> : <span class="id" title="var">nat</span>).<br/>
</div>

<div class="doc">
A <i>handler</i> for <span class="inlinecode"><span class="id" title="var">Minus</span></span>: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">hminus</span> : <span class="id" title="var">Minus</span> → <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> '(<span class="id" title="var">sub</span> <span class="id" title="var">n<sub>1</sub></span> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <span class="id" title="var">n<sub>1</sub></span> - <span class="id" title="var">n<sub>2</sub></span>.<br/>
</div>

<div class="doc">
used for evaluation 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">evalm</span> := <span class="id" title="var">fold_eval</span> <span class="id" title="var">hminus</span>.<br/>
</div>

<div class="doc">
<a id="lab223"></a><h3 class="section"> </h3>

</div>
<div class="code">
<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>3</sub></span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Minus</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">sub</span> 4 3).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">evalm</span> <span class="id" title="var">e<sub>3</sub></span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">1</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab224"></a><h3 class="section"> </h3>

</div>
<div class="code">
<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>4</sub></span> : <span class="id" title="var">Expr</span> <span class="id" title="var">Minus</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">sub</span> 2 1);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">sub</span> 6 3);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">sub</span> <span class="id" title="var">y</span> <span class="id" title="var">x</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">evalm</span> <span class="id" title="var">e<sub>4</sub></span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">2</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab225"></a><h3 class="section">Supporting Multiple Operations</h3>
 Define the <i>disjoint sum</i> of operations: 
</div>
<div class="code">
<span class="id" title="keyword">Notation</span> &quot;Op<sub>1</sub> +' Op<sub>2</sub>" := ((<span class="id" title="var">Op<sub>1</sub></span> + <span class="id" title="var">Op<sub>2</sub></span>)%<span class="id" title="keyword">type</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10).<br/>
</div>

<div class="doc">
An expression of type <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode">(<span class="id" title="var">Plus</span></span> <span class="inlinecode">+'</span> <span class="inlinecode"><span class="id" title="var">Minus</span>)</span> can perform <i>both</i> operations 
<div class="paragraph"> </div>

 Furthermore, we can combine two <i>handlers</i> generically: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">hsum</span> {<span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span>} (<span class="id" title="var">h<sub>1</sub></span> : <span class="id" title="var">Op<sub>1</sub></span> → <span class="id" title="var">nat</span>) (<span class="id" title="var">h<sub>2</sub></span> : <span class="id" title="var">Op<sub>2</sub></span> → <span class="id" title="var">nat</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="var">Op<sub>1</sub></span> +' <span class="id" title="var">Op<sub>2</sub></span> → <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="keyword">match</span> <span class="id" title="var">op</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">inl</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="var">h<sub>1</sub></span> <span class="id" title="var">op</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">inr</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="var">h<sub>2</sub></span> <span class="id" title="var">op</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Notation</span> &quot;h<sub>1</sub> ⊕ h<sub>2</sub>" := (<span class="id" title="var">hsum</span> <span class="id" title="var">h<sub>1</sub></span> <span class="id" title="var">h<sub>2</sub></span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10).<br/>
</div>

<div class="doc">
<a id="lab226"></a><h3 class="section">Example evaluation:</h3>
 We hence can evaluate mixed expressions as well without any additional
 	 definitions 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="tactic">eval</span> := <span class="id" title="var">fold_eval</span> (<span class="id" title="var">hplus</span> ⊕ <span class="id" title="var">hminus</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>5</sub></span> : <span class="id" title="var">Expr</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Minus</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">inr</span> (<span class="id" title="var">sub</span> 2 1));;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">inr</span> (<span class="id" title="var">sub</span> 6 3));;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">inl</span> (<span class="id" title="var">add</span> <span class="id" title="var">x</span> <span class="id" title="var">y</span>)).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="tactic">eval</span> <span class="id" title="var">e<sub>5</sub></span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">4</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab227"></a><h3 class="section">Using explicit <span class="inlinecode"><span class="id" title="var">inl</span></span> and <span class="inlinecode"><span class="id" title="var">inr</span></span> is painful, so...</h3>

<div class="paragraph"> </div>

 Introduce a typeclass of injections: 
</div>
<div class="code">

<span class="id" title="keyword">Class</span> <span class="id" title="var">Subop</span> <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span> := <span class="id" title="var">inject</span> : <span class="id" title="var">Op<sub>1</sub></span> → <span class="id" title="var">Op<sub>2</sub></span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">subop_refl</span> <span class="id" title="var">Op</span> : <span class="id" title="var">Subop</span> <span class="id" title="var">Op</span> <span class="id" title="var">Op</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">x</span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">subop_left</span> <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span> :<br/>
&nbsp;&nbsp;<span class="id" title="var">Subop</span> <span class="id" title="var">Op<sub>1</sub></span> (<span class="id" title="var">Op<sub>1</sub></span> +' <span class="id" title="var">Op<sub>2</sub></span>) := <span class="id" title="var">inl</span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">subop_right</span> <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span> <span class="id" title="var">Op<sub>3</sub></span> `{<span class="id" title="var">Subop</span> <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>3</sub></span>}<br/>
&nbsp;&nbsp;: <span class="id" title="var">Subop</span> <span class="id" title="var">Op<sub>1</sub></span> (<span class="id" title="var">Op<sub>2</sub></span> +' <span class="id" title="var">Op<sub>3</sub></span>)<br/>
&nbsp;&nbsp;:= <span class="id" title="keyword">fun</span> <span class="id" title="var">e</span> ⇒ <span class="id" title="var">inr</span> (<span class="id" title="var">inject</span> <span class="id" title="var">e</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <span class="id" title="var">trigger'</span> <span class="id" title="var">e</span> := (<span class="id" title="var">trigger</span> (<span class="id" title="var">inject</span> <span class="id" title="var">e</span>)).<br/>
</div>

<div class="doc">
<a id="lab228"></a><h3 class="section">Now <span class="inlinecode"><span class="id" title="var">trigger'</span></span> hides <span class="inlinecode"><span class="id" title="var">inl</span></span> and <span class="inlinecode"><span class="id" title="var">inr</span></span>:</h3>

</div>
<div class="code">

<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>5</sub>'</span> : <span class="id" title="var">Expr</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Minus</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">trigger'</span> (<span class="id" title="var">sub</span> 2 1);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">trigger'</span> (<span class="id" title="var">sub</span> 6 3);;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">trigger'</span> (<span class="id" title="var">add</span> <span class="id" title="var">x</span> <span class="id" title="var">y</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<span class="id" title="tactic">eval</span> <span class="id" title="var">e<sub>5</sub>'</span>).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">4</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab229"></a><h3 class="section">More syntactic sugar</h3>

</div>
<div class="code">
<span class="id" title="keyword">Notation</span> <span class="id" title="var">add'</span> <span class="id" title="var">n</span> <span class="id" title="var">m</span> := (<span class="id" title="var">trigger'</span> (<span class="id" title="var">add</span> <span class="id" title="var">n</span> <span class="id" title="var">m</span>)).<br/>
<span class="id" title="keyword">Notation</span> <span class="id" title="var">sub'</span> <span class="id" title="var">n</span> <span class="id" title="var">m</span> := (<span class="id" title="var">trigger'</span> (<span class="id" title="var">sub</span> <span class="id" title="var">n</span> <span class="id" title="var">m</span>)).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>5</sub>''</span> : <span class="id" title="var">Expr</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Minus</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">sub'</span> 2 1;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">sub'</span> 6 3;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">add'</span> <span class="id" title="var">x</span> <span class="id" title="var">y</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="tactic">eval</span> <span class="id" title="var">e<sub>5</sub>''</span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">4</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab230"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode"><span class="id" title="var">Op</span></span> as a semantics</h3>

<div class="paragraph"> </div>

 Note that, instead of seeing <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode"><span class="id" title="var">Op</span></span> as our programming language itself,
   we can see it alternatively as a <i>semantic domain</i> for our original syntax.

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">ExprAST</span> : <span class="id" title="keyword">Set</span> :=<br/>
| <span class="id" title="var">ValAST</span> (<span class="id" title="var">n</span> : <span class="id" title="var">nat</span>)<br/>
| <span class="id" title="var">AddAST</span> (<span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> : <span class="id" title="var">ExprAST</span>)<br/>
| <span class="id" title="var">MinusAST</span> (<span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> : <span class="id" title="var">ExprAST</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">repr</span> (<span class="id" title="var">e</span> : <span class="id" title="var">ExprAST</span>) : <span class="id" title="var">Expr</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Minus</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">ValAST</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">Val</span> <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">AddAST</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">repr</span> <span class="id" title="var">e<sub>1</sub></span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">repr</span> <span class="id" title="var">e<sub>2</sub></span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">add'</span> <span class="id" title="var">x</span> <span class="id" title="var">y</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">MinusAST</span> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">x</span> &lt;- <span class="id" title="var">repr</span> <span class="id" title="var">e<sub>1</sub></span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">y</span> &lt;- <span class="id" title="var">repr</span> <span class="id" title="var">e<sub>2</sub></span>;;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">sub'</span> <span class="id" title="var">x</span> <span class="id" title="var">y</span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">sem</span> (<span class="id" title="var">e</span> : <span class="id" title="var">ExprAST</span>) : <span class="id" title="var">nat</span> := <span class="id" title="tactic">eval</span> (<span class="id" title="var">repr</span> <span class="id" title="var">e</span>).<br/>
</div>

<div class="doc">
<a id="lab231"></a><h3 class="section"> </h3>

</div>
<div class="code">

<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>6</sub></span> : <span class="id" title="var">ExprAST</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">MinusAST</span> (<span class="id" title="var">AddAST</span> (<span class="id" title="var">ValAST</span> 3) (<span class="id" title="var">ValAST</span> 4)) (<span class="id" title="var">ValAST</span> 5).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<span class="id" title="var">sem</span> <span class="id" title="var">e<sub>6</sub></span>).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">2</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
</div>

<div class="doc">
<a id="lab232"></a><h2 class="section">Free Monads</h2>

<div class="paragraph"> </div>

 <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode"><span class="id" title="var">Op</span></span> was specific to <span class="inlinecode"><span class="id" title="var">nat</span></span> operators and <span class="inlinecode"><span class="id" title="var">nat</span></span> computations.
  We can make it more generic:  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">FFree</span> (<span class="id" title="var">E</span> : <span class="id" title="keyword">Type</span> → <span class="id" title="keyword">Type</span>) (<span class="id" title="var">R</span> : <span class="id" title="keyword">Type</span>) : <span class="id" title="keyword">Type</span> :=<br/>
| <span class="id" title="var">Ret</span> (<span class="id" title="var">x</span> : <span class="id" title="var">R</span>)<br/>
| <span class="id" title="var">Do</span> {<span class="id" title="var">X</span>} (<span class="id" title="var">op</span> : <span class="id" title="var">E</span> <span class="id" title="var">X</span>) (<span class="id" title="var">k</span> : <span class="id" title="var">X</span> → <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">R</span>).<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
Note that <span class="inlinecode"><span class="id" title="var">op</span></span> is now characterized by an indexed type <span class="inlinecode"><span class="id" title="var">E</span></span>, and <span class="inlinecode"><span class="id" title="var">op</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">X</span></span>
means that, semantically, <span class="inlinecode"><span class="id" title="var">op</span></span> produces an <span class="inlinecode"><span class="id" title="var">X</span></span> (which will be fed to the
continuation <span class="inlinecode"><span class="id" title="var">k</span></span>).

<div class="paragraph"> </div>

<a id="lab233"></a><h3 class="section">Operations, dependently</h3>

<div class="paragraph"> </div>

 In this format, the signature of the addition operation looks like the following: 
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Plus</span> : <span class="id" title="keyword">Type</span> → <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">add</span> (<span class="id" title="var">n<sub>1</sub></span> <span class="id" title="var">n<sub>2</sub></span> : <span class="id" title="var">nat</span>) : <span class="id" title="var">Plus</span> <span class="id" title="var">nat</span>.<br/>
</div>

<div class="doc">
Or, for Boolean operations:  
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <span class="id" title="var">BoolOp</span> : <span class="id" title="keyword">Type</span> → <span class="id" title="keyword">Type</span> :=<br/>
| <span class="id" title="var">or</span>  (<span class="id" title="var">b<sub>1</sub></span> <span class="id" title="var">b<sub>2</sub></span> : <span class="id" title="var">bool</span>) : <span class="id" title="var">BoolOp</span> <span class="id" title="var">bool</span><br/>
| <span class="id" title="var">not</span> (<span class="id" title="var">b</span> : <span class="id" title="var">bool</span>) : <span class="id" title="var">BoolOp</span> <span class="id" title="var">bool</span>.<br/>
</div>

<div class="doc">
<a id="lab234"></a><h3 class="section">Handling operations</h3>

<div class="paragraph"> </div>

 The implementation of an operation is now aware of the type it must implement. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">hplus</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, <span class="id" title="var">Plus</span> <span class="id" title="var">X</span> → <span class="id" title="var">X</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> '(<span class="id" title="var">add</span> <span class="id" title="var">n<sub>1</sub></span> <span class="id" title="var">n<sub>2</sub></span>) ⇒ <span class="id" title="var">n<sub>1</sub></span> + <span class="id" title="var">n<sub>2</sub></span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <span class="id" title="var">hbool</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, <span class="id" title="var">BoolOp</span> <span class="id" title="var">X</span> → <span class="id" title="var">X</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="keyword">match</span> <span class="id" title="var">op</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">or</span> <span class="id" title="var">b<sub>1</sub></span> <span class="id" title="var">b<sub>2</sub></span> ⇒ <span class="id" title="var">orb</span> <span class="id" title="var">b<sub>1</sub></span> <span class="id" title="var">b<sub>2</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">not</span> <span class="id" title="var">b</span> ⇒ <span class="id" title="var">negb</span> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab235"></a><h3 class="section"><span class="inlinecode"><span class="id" title="var">fold_pure</span></span>, generically</h3>

<div class="paragraph"> </div>

 We can now write a "fold" operation that computes a result of type <span class="inlinecode"><span class="id" title="var">R</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">fold_pure</span> {<span class="id" title="var">E</span> <span class="id" title="var">R</span>} (<span class="id" title="var">h</span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, <span class="id" title="var">E</span> <span class="id" title="var">X</span> → <span class="id" title="var">X</span>) (<span class="id" title="var">t</span> : <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">R</span>) : <span class="id" title="var">R</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Ret</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">k</span> ⇒ <span class="id" title="var">fold_pure</span> <span class="id" title="var">h</span> (<span class="id" title="var">k</span> (<span class="id" title="var">h</span> <span class="id" title="var">_</span> <span class="id" title="var">op</span>))<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab236"></a><h3 class="section">Sequential composition</h3>

<div class="paragraph"> </div>

 We can rebuild the machinery from before, but this time <span class="inlinecode"><span class="id" title="var">seq</span></span> <i>is</i> the <span class="inlinecode"><span class="id" title="var">bind</span></span> of a monad <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>. 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <span class="id" title="var">seq</span> {<span class="id" title="var">E</span> <span class="id" title="var">X</span> <span class="id" title="var">Y</span>} (<span class="id" title="var">e</span> : <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">X</span>) (<span class="id" title="var">k</span> : <span class="id" title="var">X</span> → <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">Y</span>) : <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">Y</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Ret</span> <span class="id" title="var">x</span>   ⇒ <span class="id" title="var">k</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">h</span> ⇒ <span class="id" title="var">Do</span> <span class="id" title="var">op</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">seq</span> (<span class="id" title="var">h</span> <span class="id" title="var">n</span>) <span class="id" title="var">k</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">FFreeM</span> {<span class="id" title="var">E</span>} : <span class="id" title="var">Monad</span> (<span class="id" title="var">FFree</span> <span class="id" title="var">E</span>) :=<br/>
{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">ret</span> := @<span class="id" title="var">Ret</span> <span class="id" title="var">E</span><br/>
&nbsp;&nbsp;; <span class="id" title="var">bind</span> := @<span class="id" title="var">seq</span> <span class="id" title="var">E</span><br/>
|}.<br/>
</div>

<div class="doc">
<a id="lab237"></a><h3 class="section">Equivalence of <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> computations</h3>

<div class="paragraph"> </div>

 We define an appropriate notion of equivalence.

<div class="paragraph"> </div>

Note that the continuations are required to be <i>extensionally equivalent</i>.  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">eq_FFree</span> {<span class="id" title="var">E</span> <span class="id" title="var">X</span>} : <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">X</span> → <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">X</span> → <span class="id" title="keyword">Prop</span> :=<br/>
| <span class="id" title="var">eq_Ret</span> : <span class="id" title="keyword">∀</span> (<span class="id" title="var">x</span>:<span class="id" title="var">X</span>), <span class="id" title="var">eq_FFree</span> (<span class="id" title="var">Ret</span> <span class="id" title="var">x</span>) (<span class="id" title="var">Ret</span> <span class="id" title="var">x</span>)<br/>
| <span class="id" title="var">eq_Do</span>  : <span class="id" title="keyword">∀</span> {<span class="id" title="var">Y</span>} (<span class="id" title="var">op</span> : <span class="id" title="var">E</span> <span class="id" title="var">Y</span>) (<span class="id" title="var">k<sub>1</sub></span> <span class="id" title="var">k<sub>2</sub></span> : <span class="id" title="var">Y</span> → <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id" title="var">Heq</span>: <span class="id" title="keyword">∀</span> (<span class="id" title="var">y<sub>1</sub></span> <span class="id" title="var">y<sub>2</sub></span>:<span class="id" title="var">Y</span>), <span class="id" title="var">y<sub>1</sub></span> = <span class="id" title="var">y<sub>2</sub></span> → <span class="id" title="var">eq_FFree</span> (<span class="id" title="var">k<sub>1</sub></span> <span class="id" title="var">y<sub>1</sub></span>) (<span class="id" title="var">k<sub>2</sub></span> <span class="id" title="var">y<sub>2</sub></span>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">eq_FFree</span> (<span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">k<sub>1</sub></span>) (<span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">k<sub>2</sub></span>).<br/>
</div>

<div class="doc">
Use straightforward induction to prove that <span class="inlinecode"><span class="id" title="var">eq_FFree</span></span> is an equivalence relation. 
</div>
<div class="code">

#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">eqM_FFree</span> {<span class="id" title="var">E</span>} : <span class="id" title="var">EqM</span> (<span class="id" title="var">FFree</span> <span class="id" title="var">E</span>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">A</span> ⇒ (@<span class="id" title="var">eq_FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">A</span>).<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <span class="id" title="var">eqM_FFree_Equiv</span> {<span class="id" title="var">E</span>} : <span class="id" title="var">EqMEquivalence</span> (<span class="id" title="var">FFree</span> <span class="id" title="var">E</span>).<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>; <span class="id" title="var">typeclasses</span> <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a id="lab238"></a><h3 class="section">Monad Laws for <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> :</h3>

<div class="paragraph"> </div>

 Next we prove the monad laws, but they follow straightforwardly by
induction: 
</div>
<div class="code">
#[<span class="id" title="var">local</span>]  <span class="id" title="keyword">Instance</span> <span class="id" title="var">eqm_FFree_monad_laws</span> {<span class="id" title="var">E</span>} : <span class="id" title="var">MonadLaws</span> (<span class="id" title="var">FFree</span> <span class="id" title="var">E</span>).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span> <span class="id" title="var">C</span> <span class="id" title="var">ma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">ma</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">rewrite</span> <span class="id" title="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span> <span class="id" title="var">C</span> <span class="id" title="var">ma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">m</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">subst</span>. <span class="id" title="tactic">rewrite</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">red</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span> <span class="id" title="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">x</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span> <span class="id" title="var">Heq</span> <span class="id" title="var">k<sub>1</sub></span> <span class="id" title="var">k<sub>2</sub></span> <span class="id" title="var">HK</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">inversion</span> <span class="id" title="var">Heq</span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">apply</span> <span class="id" title="var">HK</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">inversion</span> <span class="id" title="var">Heq</span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">inj_pair2</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>2</sub></span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">inj_pair2</span> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>3</sub></span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">apply</span> <span class="id" title="var">Heq0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assumption</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a id="lab239"></a><h3 class="section">Disjoint sum of Indexed Types</h3>

<div class="paragraph"> </div>

 Now that our operation types are indexed by their return types, we need to
provide an appropriate notion of "disjoint union": 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">sumi</span> (<span class="id" title="var">E<sub>1</sub></span> <span class="id" title="var">E<sub>2</sub></span> : <span class="id" title="keyword">Type</span> → <span class="id" title="keyword">Type</span>) (<span class="id" title="var">X</span> : <span class="id" title="keyword">Type</span>) : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">inli</span> (<span class="id" title="var">_</span> : <span class="id" title="var">E<sub>1</sub></span> <span class="id" title="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">inri</span> (<span class="id" title="var">_</span> : <span class="id" title="var">E<sub>2</sub></span> <span class="id" title="var">X</span>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> &quot;Op<sub>1</sub> +' Op<sub>2</sub>" := (<span class="id" title="var">sumi</span> <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10).<br/>
</div>

<div class="doc">
We can also "sum" <i>handlers</i>: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">hpure_sum</span> {<span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span>} (<span class="id" title="var">h<sub>1</sub></span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">X</span> → <span class="id" title="var">X</span>) (<span class="id" title="var">h<sub>2</sub></span> : <span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, <span class="id" title="var">Op<sub>2</sub></span> <span class="id" title="var">X</span> → <span class="id" title="var">X</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, (<span class="id" title="var">Op<sub>1</sub></span> +' <span class="id" title="var">Op<sub>2</sub></span>) <span class="id" title="var">X</span> → <span class="id" title="var">X</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="keyword">match</span> <span class="id" title="var">op</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">inli</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="var">h<sub>1</sub></span> <span class="id" title="var">_</span> <span class="id" title="var">op</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">inri</span> <span class="id" title="var">op</span> ⇒ <span class="id" title="var">h<sub>2</sub></span> <span class="id" title="var">_</span> <span class="id" title="var">op</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab240"></a><h3 class="section">Implicit injections</h3>
 And, using similar typeclass machinery to what we saw previously,
use inference to <span class="inlinecode"><span class="id" title="var">inject</span></span> an <span class="inlinecode"><span class="id" title="var">op</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">X</span></span> into, e.g., a sum <span class="inlinecode">(<span class="id" title="var">E</span></span> <span class="inlinecode">+'</span> <span class="inlinecode"><span class="id" title="var">F</span>)</span> <span class="inlinecode"><span class="id" title="var">X</span></span>.    
</div>

<div class="doc">
Which allows us to define a generic <span class="inlinecode"><span class="id" title="var">trigger</span></span> operation: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">trigger_</span> {<span class="id" title="var">E</span> <span class="id" title="var">X</span>} (<span class="id" title="var">e</span> : <span class="id" title="var">E</span> <span class="id" title="var">X</span>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="var">Do</span> <span class="id" title="var">e</span> (<span class="id" title="keyword">fun</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">Ret</span> <span class="id" title="var">x</span>).<br/>
<span class="id" title="keyword">Notation</span> <span class="id" title="var">trigger</span> <span class="id" title="var">e</span> := (<span class="id" title="var">trigger_</span> (<span class="id" title="var">inject</span> <span class="id" title="var">e</span>)).<br/>
</div>

<div class="doc">
<a id="lab241"></a><h3 class="section">Putting it all together:</h3>

</div>
<div class="code">

<span class="id" title="keyword">Example</span> <span class="id" title="var">e<sub>1</sub></span> : <span class="id" title="var">FFree</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">BoolOp</span>) <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">b</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">or</span> <span class="id" title="var">true</span> <span class="id" title="var">false</span>);;<br/>
&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<span class="id" title="var">b</span> : <span class="id" title="var">bool</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">then</span> <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> 10 10)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">else</span> <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> 2 2).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="var">fold_pure</span> (<span class="id" title="var">hpure_sum</span> <span class="id" title="var">hplus</span> <span class="id" title="var">hbool</span>) <span class="id" title="var">e<sub>1</sub></span>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">20</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab242"></a><h3 class="section">Recap:</h3>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<ul class="doclist">
<li> Use the <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> monad to define computations parameterized by "syntax" for operations like <span class="inlinecode"><span class="id" title="var">Plus</span></span>.

<div class="paragraph"> </div>


</li>
<li> Define the semantics of those operations separately using <i>handlers</i>


</li>
<li> Use <span class="inlinecode"><span class="id" title="var">fold_pure</span></span> as an <i>interpreter</i> to evaluate the handlers

</li>
</ul>

<div class="paragraph"> </div>

 Aside: Technically, <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> is a <i>freer</i> monad, not the "Free" monad. 
<div class="paragraph"> </div>

<a id="lab243"></a><h3 class="section">Impure Interpretations</h3>

<div class="paragraph"> </div>

 Now consider supporting <i>impure</i> operations. 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <span class="id" title="var">Cell</span> : <span class="id" title="keyword">Type</span> → <span class="id" title="keyword">Type</span> :=<br/>
| <span class="id" title="var">Rd</span> : <span class="id" title="var">Cell</span> <span class="id" title="var">nat</span><br/>
| <span class="id" title="var">Wr</span> (<span class="id" title="var">n</span> : <span class="id" title="var">nat</span>) : <span class="id" title="var">Cell</span> <span class="id" title="var">unit</span>.<br/>
</div>

<div class="doc">
There is no problem using <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">Cell</span></span> (the operations have no semantics): 
</div>
<div class="code">

<span class="id" title="keyword">Example</span> <span class="id" title="var">double</span> : <span class="id" title="var">FFree</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Cell</span>) <span class="id" title="var">unit</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">x</span>  &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">Rd</span>;;<br/>
&nbsp;&nbsp;<span class="id" title="var">xx</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> <span class="id" title="var">x</span> <span class="id" title="var">x</span>);;<br/>
&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">Wr</span> <span class="id" title="var">xx</span>).<br/>
</div>

<div class="doc">
<a id="lab244"></a><h3 class="section">Monadic <span class="inlinecode"><span class="id" title="tactic">fold</span></span>, or Monadic Interpreters</h3>

<div class="paragraph"> </div>

 First: some handy notation for "polymorphic" functions: 
</div>
<div class="code">
<span class="id" title="keyword">Notation</span> &quot;E ~&gt; F" := (<span class="id" title="keyword">∀</span> <span class="id" title="var">X</span>, <span class="id" title="var">E</span> <span class="id" title="var">X</span> → <span class="id" title="var">F</span> <span class="id" title="var">X</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 30).<br/>
</div>

<div class="doc">
We can now redefine our folding function over monadic implementations of our effects 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <span class="id" title="tactic">fold</span> {<span class="id" title="var">E</span> <span class="id" title="var">M</span>} `{<span class="id" title="var">Monad</span> <span class="id" title="var">M</span>} (<span class="id" title="var">h</span> : <span class="id" title="var">E</span> ~&gt; <span class="id" title="var">M</span>) [<span class="id" title="var">R</span>] (<span class="id" title="var">t</span> : <span class="id" title="var">FFree</span> <span class="id" title="var">E</span> <span class="id" title="var">R</span>) : <span class="id" title="var">M</span> <span class="id" title="var">R</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">t</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Ret</span> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">ret</span> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <span class="id" title="var">Do</span> <span class="id" title="var">op</span> <span class="id" title="var">k</span> ⇒ <span class="id" title="var">x</span> &lt;- <span class="id" title="var">h</span> <span class="id" title="var">_</span> <span class="id" title="var">op</span>;; <span class="id" title="tactic">fold</span> <span class="id" title="var">h</span> (<span class="id" title="var">k</span> <span class="id" title="var">x</span>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab245"></a><h3 class="section">A handler can now be monadic</h3>

<div class="paragraph"> </div>

 The type of this handler returns a computation in the <span class="inlinecode"><span class="id" title="var">state</span></span> monad: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <span class="id" title="var">hcell</span> : <span class="id" title="var">Cell</span> ~&gt; <span class="id" title="var">state</span> <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">e</span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <span class="id" title="var">e</span> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Wr</span> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">put</span> <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <span class="id" title="var">Rd</span>   ⇒ <span class="id" title="var">get</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Intuitively, this means that we can <i>interpret</i> the operations <span class="inlinecode"><span class="id" title="var">Wr</span></span> and <span class="inlinecode"><span class="id" title="var">Rd</span></span>
by their semantic counterpart. 
<div class="paragraph"> </div>

<a id="lab246"></a><h3 class="section">Lifting computations</h3>
 We do have to <i>lift</i> the pure handler <span class="inlinecode"><span class="id" title="var">hplus</span></span> into the <span class="inlinecode"><span class="id" title="var">state</span></span> monad. 
<div class="paragraph"> </div>

 With a bit more help from typeclasses, we could do it automatically. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <span class="id" title="var">hplusS</span> : <span class="id" title="var">Plus</span> ~&gt; <span class="id" title="var">state</span> <span class="id" title="var">nat</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <span class="id" title="var">e</span> ⇒ <span class="id" title="var">ret</span> (<span class="id" title="var">hplus</span> <span class="id" title="var">_</span> <span class="id" title="var">e</span>).<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
<a id="lab247"></a><h3 class="section">Running the example</h3>

<div class="paragraph"> </div>

  Recalling our example from earlier:
<br/>
<span class="inlinecode"><span class="id" title="keyword">Example</span> <span class="id" title="var">double</span> : <span class="id" title="var">FFree</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Cell</span>) <span class="id" title="var">unit</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">x</span>  &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">Rd</span>;;<br/>
&nbsp;&nbsp;<span class="id" title="var">xx</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> <span class="id" title="var">x</span> <span class="id" title="var">x</span>);;<br/>
&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">Wr</span> <span class="id" title="var">xx</span>).
</span>
<div class="paragraph"> </div>

 We can now run it in the <span class="inlinecode"><span class="id" title="var">state</span></span> monad: 
</div>
<div class="code">

<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <span class="id" title="tactic">fold</span> (<span class="id" title="var">hplusS</span> ⊕ <span class="id" title="var">hcell</span>) <span class="id" title="var">double</span> 16.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">(32,</span> <span class="inlinecode"><span class="id" title="var">tt</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> <span class="inlinecode">×</span> <span class="inlinecode"><span class="id" title="var">unit</span></span> 
</div>
<div class="code">

<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<span class="id" title="tactic">fold</span> (<span class="id" title="var">hplusS</span> ⊕ <span class="id" title="var">hcell</span>) (<span class="id" title="var">double</span> ;; <span class="id" title="var">trigger</span> <span class="id" title="var">Rd</span>) 42).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">(84,</span> <span class="inlinecode">84)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> <span class="inlinecode">×</span> <span class="inlinecode"><span class="id" title="var">unit</span></span> 
</div>

<div class="doc">
<a id="lab248"></a><h2 class="section">Next: <span class="inlinecode"><span class="id" title="var">ITrees</span></span></h2>

<div class="paragraph"> </div>

 At this point, are we ready to tackle  <span class="inlinecode"><span class="id" title="var">ITrees</span></span> 
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>