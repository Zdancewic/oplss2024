<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="common/css/sf.css" rel="stylesheet" type="text/css" />
<title>Free</title>
<link href="common/jquery-ui/jquery-ui.css" rel="stylesheet">
<script src="common/jquery-ui/external/jquery/jquery.js"></script>
<script src="common/jquery-ui/jquery-ui.js"></script>
<script src="common/toggleproofs.js"></script>
<link href="common/css/rip.css" rel="stylesheet" type="text/css"/>
</head>

<body>

<div id="page">

<div id="header">
<div id='logoinheader'><a href='https://softwarefoundations.cis.upenn.edu'>
<img src='common/media/image/sf_logo_sm.png' alt='Software Foundations Logo'></a></div>
<div class='booktitleinheader'><a href='index.html'>Volume 7: Reasoning about Interactive Programs</a></div>
<ul id='menu'>
   <li class='section_name'><a href='toc.html'>Table of Contents</a></li>
   <li class='section_name'><a href='coqindex.html'>Index</a></li>
</ul>
</div>

<div id="main">

<h1 class="libtitle">Free</h1>


<div class="doc">
<a id="lab167"></a><h2 class="section">Extensible Semantics and the <span class="inlinecode"><span class="id" title="var">Free</span></span> Monad</h2>
 Through this chapter, we introduce successive intuitions to build up to the
 Interaction Tree monad, a convenient data-structure for building semantic
 domains. As we will see, Interaction Trees are one way to solve the
 problem of representing divergent computations in Coq.  They also share
 many properties with something called a "free monad", which is the topic
 of this Chapter.

<div class="paragraph"> </div>

 We start by looking at how to create an extensible evaluator for simple
 arithmetic expressions.
 
</div>

<div class="doc">
Consider a trivial datatype of expressions, made of only constants
 and additions: 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="Expr.Expr" class="idref" href="#Expr.Expr"><span class="id" title="definition, inductive"><span id="Expr.Expr_rect" class="id"><span id="Expr.Expr_ind" class="id"><span id="Expr.Expr_rec" class="id"><span id="Expr.Expr_sind" class="id">Expr</span></span></span></span></span></a> : <span class="id" title="keyword">Set</span> :=<br/>
| <a id="Expr.Val" class="idref" href="#Expr.Val"><span class="id" title="constructor">Val</span></a> (<a id="n:3" class="idref" href="#n:3"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
| <a id="Expr.Add" class="idref" href="#Expr.Add"><span class="id" title="constructor">Add</span></a> (<a id="e<sub>1</sub>:4" class="idref" href="#e<sub>1</sub>:4"><span class="id" title="binder">e<sub>1</sub></span></a> <a id="e<sub>2</sub>:5" class="idref" href="#e<sub>2</sub>:5"><span class="id" title="binder">e<sub>2</sub></span></a> : <a class="idref" href="Free.html#Expr:1"><span class="id" title="inductive">Expr</span></a>).<br/>
</div>

<div class="doc">
We may easily define functions that fold over this datatype. For instance, an
 evaluation function: 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <a id="Expr.eval" class="idref" href="#Expr.eval"><span class="id" title="definition">eval</span></a> (<a id="e:6" class="idref" href="#e:6"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#Expr.Expr"><span class="id" title="inductive">Expr</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#e:6"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Expr.Val"><span class="id" title="constructor">Val</span></a> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Expr.Add"><span class="id" title="constructor">Add</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <a class="idref" href="Free.html#eval:7"><span class="id" title="definition">eval</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> <a class="idref" href="Free.html#eval:7"><span class="id" title="definition">eval</span></a> <span class="id" title="var">e<sub>2</sub></span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="Expr.e" class="idref" href="#Expr.e"><span class="id" title="definition">e</span></a> : <a class="idref" href="Free.html#Expr.Expr"><span class="id" title="inductive">Expr</span></a> := <a class="idref" href="Free.html#Expr.Add"><span class="id" title="constructor">Add</span></a> (<a class="idref" href="Free.html#Expr.Val"><span class="id" title="constructor">Val</span></a> 3) (<a class="idref" href="Free.html#Expr.Val"><span class="id" title="constructor">Val</span></a> 4).<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#Expr.eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="Free.html#Expr.e"><span class="id" title="definition">e</span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab168"></a><h3 class="section">The expression problem</h3>
 Philip Wadler phrased in 1998 the <i>expression problem</i> as the following challenge:
Can one define a data type by cases where one can add new cases to the data types, while still being able to define new functions over the data
   type, without recompiling existing code, all while retaining type safety?
   
<div class="paragraph"> </div>

 Indeed, if decide to add subtraction to these expressions, our best bet
   seems to be to edit the definition of <span class="inlinecode"><span class="id" title="var">Expr</span></span>, and then extend the <span class="inlinecode"><span class="id" title="tactic">eval</span></span>
   function.  It is here trivial, but scales poorly!  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="Expr.Expr'" class="idref" href="#Expr.Expr'"><span class="id" title="definition, inductive"><span id="Expr.Expr'_rect" class="id"><span id="Expr.Expr'_ind" class="id"><span id="Expr.Expr'_rec" class="id"><span id="Expr.Expr'_sind" class="id">Expr'</span></span></span></span></span></a> : <span class="id" title="keyword">Set</span> :=<br/>
| <a id="Expr.Val'" class="idref" href="#Expr.Val'"><span class="id" title="constructor">Val'</span></a> (<a id="n:11" class="idref" href="#n:11"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
| <a id="Expr.Add'" class="idref" href="#Expr.Add'"><span class="id" title="constructor">Add'</span></a> (<a id="e<sub>1</sub>:12" class="idref" href="#e<sub>1</sub>:12"><span class="id" title="binder">e<sub>1</sub></span></a> <a id="e<sub>2</sub>:13" class="idref" href="#e<sub>2</sub>:13"><span class="id" title="binder">e<sub>2</sub></span></a> : <a class="idref" href="Free.html#Expr':9"><span class="id" title="inductive">Expr'</span></a>)<br/>
| <a id="Expr.Minus'" class="idref" href="#Expr.Minus'"><span class="id" title="constructor">Minus'</span></a> (<a id="e<sub>1</sub>:14" class="idref" href="#e<sub>1</sub>:14"><span class="id" title="binder">e<sub>1</sub></span></a> <a id="e<sub>2</sub>:15" class="idref" href="#e<sub>2</sub>:15"><span class="id" title="binder">e<sub>2</sub></span></a> : <a class="idref" href="Free.html#Expr':9"><span class="id" title="inductive">Expr'</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="Expr.eval'" class="idref" href="#Expr.eval'"><span class="id" title="definition">eval'</span></a> (<a id="e:16" class="idref" href="#e:16"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#Expr.Expr'"><span class="id" title="inductive">Expr'</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#e:16"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Expr.Val'"><span class="id" title="constructor">Val'</span></a> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Expr.Add'"><span class="id" title="constructor">Add'</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <a class="idref" href="Free.html#eval':17"><span class="id" title="definition">eval'</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> <a class="idref" href="Free.html#eval':17"><span class="id" title="definition">eval'</span></a> <span class="id" title="var">e<sub>2</sub></span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Expr.Minus'"><span class="id" title="constructor">Minus'</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒ <a class="idref" href="Free.html#eval':17"><span class="id" title="definition">eval'</span></a> <span class="id" title="var">e<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#::nat_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="Free.html#eval':17"><span class="id" title="definition">eval'</span></a> <span class="id" title="var">e<sub>2</sub></span><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="Expr.e'" class="idref" href="#Expr.e'"><span class="id" title="definition">e'</span></a> : <a class="idref" href="Free.html#Expr.Expr'"><span class="id" title="inductive">Expr'</span></a> := <a class="idref" href="Free.html#Expr.Minus'"><span class="id" title="constructor">Minus'</span></a> (<a class="idref" href="Free.html#Expr.Val'"><span class="id" title="constructor">Val'</span></a> 7) (<a class="idref" href="Free.html#Expr.Val'"><span class="id" title="constructor">Val'</span></a> 4).<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#Expr.eval'"><span class="id" title="definition">eval'</span></a> <a class="idref" href="Free.html#Expr.e'"><span class="id" title="definition">e'</span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">3</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
</div>

<div class="doc">
<a id="lab169"></a><h3 class="section">One solution (Datatypes à la carte)</h3>

<div class="paragraph"> </div>

 We consider here a solution to the expression problem popularized by Wouter
  Swierstra in "Datatypes à la carte".  (Our case is a bit simplified and we make
  adaptations to move from Haskell to Coq.)

<div class="paragraph"> </div>

 Consider the following new langage of expressions. It is parameterized by a
 certain domain of operations <span class="inlinecode"><span class="id" title="var">Op</span></span>, and can represent expressions built out of two
 constructors:
  Add a parameter so <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode"><span class="id" title="var">Op</span></span> is now either
<ul class="doclist">
<li> a value, or,

</li>
<li> a computation that first performs an <span class="inlinecode"><span class="id" title="var">Op</span></span>, and then builds a new expression indexed by a natural number.

</li>
</ul>

<div class="paragraph"> </div>

  In the latter case, we think of the index provided to continuation <span class="inlinecode"><span class="id" title="var">k</span></span> as the result of computing <span class="inlinecode"><span class="id" title="var">op</span></span>.

<div class="paragraph"> </div>

 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="FreeExpr.Expr" class="idref" href="#FreeExpr.Expr"><span class="id" title="definition, inductive"><span id="FreeExpr.Expr_rect" class="id"><span id="FreeExpr.Expr_ind" class="id"><span id="FreeExpr.Expr_rec" class="id"><span id="FreeExpr.Expr_sind" class="id">Expr</span></span></span></span></span></a> (<a id="Op:19" class="idref" href="#Op:19"><span class="id" title="binder">Op</span></a> : <span class="id" title="keyword">Type</span>) :=<br/>
| <a id="FreeExpr.Val" class="idref" href="#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> (<a id="n:22" class="idref" href="#n:22"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
| <a id="FreeExpr.Do" class="idref" href="#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> (<a id="op:23" class="idref" href="#op:23"><span class="id" title="binder">op</span></a> : <a class="idref" href="Free.html#Op:19"><span class="id" title="variable">Op</span></a>) (<a id="k:24" class="idref" href="#k:24"><span class="id" title="binder">k</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#Expr:20"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#Op:19"><span class="id" title="variable">Op</span></a>).<br/>
</div>

<div class="doc">
<a id="lab170"></a><h3 class="section">Instantiating <span class="inlinecode"><span class="id" title="var">Op</span></span></h3>

<div class="paragraph"> </div>

 To recover the expressiveness of the language from before, let us define an
operation to perform additions: it takes two <span class="inlinecode"><span class="id" title="var">nat</span></span>s as arguments. Though we think
of <span class="inlinecode"><span class="id" title="var">Plus</span></span> as the the operations that sums its inputs, note that this definition
doesn't actually say anything about that.  This is still just <i>syntax</i> for
the operation. 
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <a id="FreeExpr.Plus" class="idref" href="#FreeExpr.Plus"><span class="id" title="definition, inductive"><span id="FreeExpr.Plus_rect" class="id"><span id="FreeExpr.Plus_ind" class="id"><span id="FreeExpr.Plus_rec" class="id"><span id="FreeExpr.Plus_sind" class="id">Plus</span></span></span></span></span></a> := <a id="FreeExpr.add" class="idref" href="#FreeExpr.add"><span class="id" title="constructor">add</span></a> (<a id="n<sub>1</sub>:27" class="idref" href="#n<sub>1</sub>:27"><span class="id" title="binder">n<sub>1</sub></span></a> <a id="n<sub>2</sub>:28" class="idref" href="#n<sub>2</sub>:28"><span class="id" title="binder">n<sub>2</sub></span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>).<br/>
</div>

<div class="doc">
It looks a bit weird, but we can write the <span class="inlinecode"><span class="id" title="var">Expr</span></span> summing 3 and 4 and
returning the result as follows:  
</div>
<div class="code">
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e" class="idref" href="#FreeExpr.e"><span class="id" title="definition">e</span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> := <a class="idref" href="Free.html#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> 3 4) (<span class="id" title="keyword">fun</span> <a id="n:29" class="idref" href="#n:29"><span class="id" title="binder">n</span></a> ⇒ <a class="idref" href="Free.html#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> <a class="idref" href="Free.html#n:29"><span class="id" title="variable">n</span></a>).<br/>
</div>

<div class="doc">
The next thing we wanted to do is to define an evaluation function. We could
do it directly: 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <a id="FreeExpr.eval_naive" class="idref" href="#FreeExpr.eval_naive"><span class="id" title="definition">eval_naive</span></a> (<a id="t:30" class="idref" href="#t:30"><span class="id" title="binder">t</span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#t:30"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> <span class="id" title="var">n</span> <span class="id" title="var">m</span>) <span class="id" title="var">k</span> ⇒ <a class="idref" href="Free.html#eval_naive:31"><span class="id" title="definition">eval_naive</span></a> (<span class="id" title="var">k</span> (<span class="id" title="var">n</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> <span class="id" title="var">m</span>))<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<a class="idref" href="Free.html#FreeExpr.eval_naive"><span class="id" title="definition">eval_naive</span></a> <a class="idref" href="Free.html#FreeExpr.e"><span class="id" title="definition">e</span></a>).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 But if we did that, we would have a weirder syntax, and gained nothing. 
<div class="paragraph"> </div>

 Instead, we can notice that we can abstract away the concrete
computation that we perform to realize our operation.  Consider an expression
over an arbitrary signature <span class="inlinecode"><span class="id" title="var">Op</span></span>, rather than specifically <span class="inlinecode"><span class="id" title="var">Plus</span></span>, and assume
that you are given a function that knows how to evaluate any such operation into
a <span class="inlinecode"><span class="id" title="var">nat</span></span>.  
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="FreeExpr.fold_eval" class="idref" href="#FreeExpr.fold_eval"><span class="id" title="definition">fold_eval</span></a> {<a id="Op:33" class="idref" href="#Op:33"><span class="id" title="binder">Op</span></a>} (<a id="h:34" class="idref" href="#h:34"><span class="id" title="binder">h</span></a> : <a class="idref" href="Free.html#Op:33"><span class="id" title="variable">Op</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) (<a id="t:35" class="idref" href="#t:35"><span class="id" title="binder">t</span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#Op:33"><span class="id" title="variable">Op</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#t:35"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> <span class="id" title="var">n</span> ⇒ <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> <span class="id" title="var">k</span> ⇒ <a class="idref" href="Free.html#fold_eval:36"><span class="id" title="definition">fold_eval</span></a> <a class="idref" href="Free.html#h:34"><span class="id" title="variable">h</span></a> (<span class="id" title="var">k</span> (<a class="idref" href="Free.html#h:34"><span class="id" title="variable">h</span></a> <span class="id" title="var">op</span>))<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Then we can, in particular, define <i>in isolation</i> what we do for <span class="inlinecode"><span class="id" title="var">Plus</span></span> 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.hplus" class="idref" href="#FreeExpr.hplus"><span class="id" title="definition">hplus</span></a> : <a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> '(<a id="pat:40" class="idref" href="#pat:40"><span class="id" title="binder">add</span></a> <a id="n<sub>1</sub>:39" class="idref" href="#n<sub>1</sub>:39"><span class="id" title="binder"><span id="pat:40" class="id">n<sub>1</sub></span></span></a> <a id="n<sub>2</sub>:38" class="idref" href="#n<sub>2</sub>:38"><span class="id" title="binder"><span id="pat:40" class="id">n<sub>2</sub></span></span></a>) ⇒ <a class="idref" href="Free.html#n<sub>1</sub>:39"><span class="id" title="variable">n<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> <a class="idref" href="Free.html#n<sub>2</sub>:38"><span class="id" title="variable">n<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
And we obtain our evaluation function by feeding <span class="inlinecode"><span class="id" title="var">hplus</span></span> to our generic
 folding function.

</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.evalp" class="idref" href="#FreeExpr.evalp"><span class="id" title="definition">evalp</span></a> := <a class="idref" href="Free.html#FreeExpr.fold_eval"><span class="id" title="definition">fold_eval</span></a> <a class="idref" href="Free.html#FreeExpr.hplus"><span class="id" title="definition">hplus</span></a>.<br/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.evalp"><span class="id" title="definition">evalp</span></a> <a class="idref" href="Free.html#FreeExpr.e"><span class="id" title="definition">e</span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 Before moving further, let's introduce a few constructions and notations
 to hide the syntactic awkwardness.

<div class="paragraph"> </div>

 First, note that we can build the sequence of two computations quite
 easily: our terms look like abstract syntax trees, we can crawl them until we find a
 value at a leaf, and we use it as the argument to the end of the computation.
 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <a id="FreeExpr.seq" class="idref" href="#FreeExpr.seq"><span class="id" title="definition">seq</span></a> {<a id="Op:41" class="idref" href="#Op:41"><span class="id" title="binder">Op</span></a>} (<a id="e:42" class="idref" href="#e:42"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#Op:41"><span class="id" title="variable">Op</span></a>) (<a id="k:43" class="idref" href="#k:43"><span class="id" title="binder">k</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#Op:41"><span class="id" title="variable">Op</span></a>) : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#Op:41"><span class="id" title="variable">Op</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#e:42"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> <span class="id" title="var">n</span>   ⇒ <a class="idref" href="Free.html#k:43"><span class="id" title="variable">k</span></a> <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> <span class="id" title="var">h</span> ⇒ <a class="idref" href="Free.html#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> (<span class="id" title="keyword">fun</span> <a id="n:46" class="idref" href="#n:46"><span class="id" title="binder">n</span></a> ⇒ <a class="idref" href="Free.html#seq:44"><span class="id" title="definition">seq</span></a> (<span class="id" title="var">h</span> <a class="idref" href="Free.html#n:46"><span class="id" title="variable">n</span></a>) <a class="idref" href="Free.html#k:43"><span class="id" title="variable">k</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="b3068acea810c4971f3ce524b4cadeb3" class="idref" href="#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&quot;</span></a>x &lt;- t<sub>1</sub> ;; t<sub>2</sub>" := (<a class="idref" href="Free.html#FreeExpr.seq"><span class="id" title="definition">seq</span></a> <span class="id" title="var">t<sub>1</sub></span> (<span class="id" title="keyword">fun</span> <a id="x:47" class="idref" href="#x:47"><span class="id" title="binder">x</span></a> ⇒ <span class="id" title="var">t<sub>2</sub></span>))<br/>
</div>

<div class="doc">
Next, we often simply want to do an operation, and finish the computation
   with whatever value the operation resulted in.  The <span class="inlinecode"><span class="id" title="var">trigger</span></span> function
   capture this "minimal effectful computation".  
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="FreeExpr.trigger" class="idref" href="#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> {<a id="Op:48" class="idref" href="#Op:48"><span class="id" title="binder">Op</span></a>} (<a id="op:49" class="idref" href="#op:49"><span class="id" title="binder">op</span></a> : <a class="idref" href="Free.html#Op:48"><span class="id" title="variable">Op</span></a>): <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#Op:48"><span class="id" title="variable">Op</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.Do"><span class="id" title="constructor">Do</span></a> <a class="idref" href="Free.html#op:49"><span class="id" title="variable">op</span></a> (<span class="id" title="keyword">fun</span> <a id="x:50" class="idref" href="#x:50"><span class="id" title="binder">x</span></a> ⇒ <a class="idref" href="Free.html#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> <a class="idref" href="Free.html#x:50"><span class="id" title="variable">x</span></a>).<br/>
</div>

<div class="doc">
With this, we can already write examples a bit more comfortably: 
</div>
<div class="code">
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e1" class="idref" href="#FreeExpr.e1"><span class="id" title="definition">e<sub>1</sub></span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> 3 4).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.evalp"><span class="id" title="definition">evalp</span></a> <a class="idref" href="Free.html#FreeExpr.e1"><span class="id" title="definition">e<sub>1</sub></span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">7</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
</div>
<div class="code">

<span class="id" title="keyword">Example</span> <a id="FreeExpr.e2" class="idref" href="#FreeExpr.e2"><span class="id" title="definition">e<sub>2</sub></span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:51" class="idref" href="#x:51"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> 1 2)<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:52" class="idref" href="#y:52"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> 3 4)<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> <a class="idref" href="Free.html#x:51"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#y:52"><span class="id" title="variable">y</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.evalp"><span class="id" title="definition">evalp</span></a> <a class="idref" href="Free.html#FreeExpr.e2"><span class="id" title="definition">e<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">10</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 Alright, but we claimed that we would be able to extend our language without
breaking what we did so far!  To see how we can achieve this, let's now define a
signature for a substraction operation.  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="FreeExpr.Minus" class="idref" href="#FreeExpr.Minus"><span class="id" title="definition, inductive"><span id="FreeExpr.Minus_rect" class="id"><span id="FreeExpr.Minus_ind" class="id"><span id="FreeExpr.Minus_rec" class="id"><span id="FreeExpr.Minus_sind" class="id">Minus</span></span></span></span></span></a> := <a id="FreeExpr.sub" class="idref" href="#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> (<a id="n<sub>1</sub>:55" class="idref" href="#n<sub>1</sub>:55"><span class="id" title="binder">n<sub>1</sub></span></a> <a id="n<sub>2</sub>:56" class="idref" href="#n<sub>2</sub>:56"><span class="id" title="binder">n<sub>2</sub></span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>).<br/>
</div>

<div class="doc">
Its meaning can be defined in isolation as before 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.hminus" class="idref" href="#FreeExpr.hminus"><span class="id" title="definition">hminus</span></a> : <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> '(<a id="pat:59" class="idref" href="#pat:59"><span class="id" title="binder">sub</span></a> <a id="n<sub>1</sub>:58" class="idref" href="#n<sub>1</sub>:58"><span class="id" title="binder"><span id="pat:59" class="id">n<sub>1</sub></span></span></a> <a id="n<sub>2</sub>:57" class="idref" href="#n<sub>2</sub>:57"><span class="id" title="binder"><span id="pat:59" class="id">n<sub>2</sub></span></span></a>) ⇒ <a class="idref" href="Free.html#n<sub>1</sub>:58"><span class="id" title="variable">n<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#::nat_scope:x_'-'_x"><span class="id" title="notation">-</span></a> <a class="idref" href="Free.html#n<sub>2</sub>:57"><span class="id" title="variable">n<sub>2</sub></span></a>.<br/>
</div>

<div class="doc">
And used to evaluate expressions performing subtractions: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.evalm" class="idref" href="#FreeExpr.evalm"><span class="id" title="definition">evalm</span></a> := <a class="idref" href="Free.html#FreeExpr.fold_eval"><span class="id" title="definition">fold_eval</span></a> <a class="idref" href="Free.html#FreeExpr.hminus"><span class="id" title="definition">hminus</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e3" class="idref" href="#FreeExpr.e3"><span class="id" title="definition">e<sub>3</sub></span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 4 3).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.evalm"><span class="id" title="definition">evalm</span></a> <a class="idref" href="Free.html#FreeExpr.e3"><span class="id" title="definition">e<sub>3</sub></span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">1</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
</div>
<div class="code">

<span class="id" title="keyword">Example</span> <a id="FreeExpr.e4" class="idref" href="#FreeExpr.e4"><span class="id" title="definition">e<sub>4</sub></span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:60" class="idref" href="#x:60"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 2 1)<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:61" class="idref" href="#y:61"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 6 3)<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> <a class="idref" href="Free.html#y:61"><span class="id" title="variable">y</span></a> <a class="idref" href="Free.html#x:60"><span class="id" title="variable">x</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.evalm"><span class="id" title="definition">evalm</span></a> <a class="idref" href="Free.html#FreeExpr.e4"><span class="id" title="definition">e<sub>4</sub></span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">2</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 But of course we don't want to be able to work with either expressions with
 just additions, or expressions with just substractions: we want to be able to
 combine both operations!  To do that, we will observe that we can combine both
 expressions by working with the coproduct of the signatures, i.e., here the sum
 type.  
</div>
<div class="code">
<span class="id" title="keyword">Notation</span> <a id="8abdb7f3ab648ea00240dde64faec549" class="idref" href="#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">&quot;</span></a>Op<sub>1</sub> +' Op<sub>2</sub>" := ((<span class="id" title="var">Op<sub>1</sub></span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#e03f39daf98516fa530d3f6f5a1b4d<sub>92</sub>"><span class="id" title="notation">+</span></a> <span class="id" title="var">Op<sub>2</sub></span>)%<span class="id" title="keyword">type</span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10).<br/>
</div>

<div class="doc">
An expression of type <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode">(<span class="id" title="var">Plus</span></span> <span class="inlinecode">+'</span> <span class="inlinecode"><span class="id" title="var">Minus</span>)</span> can perform <i>both</i> operations 
<div class="paragraph"> </div>

 Furthermore, we can combine two <i>handlers</i> generically: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.hsum" class="idref" href="#FreeExpr.hsum"><span class="id" title="definition">hsum</span></a> {<a id="Op<sub>1</sub>:62" class="idref" href="#Op<sub>1</sub>:62"><span class="id" title="binder">Op<sub>1</sub></span></a> <a id="Op<sub>2</sub>:63" class="idref" href="#Op<sub>2</sub>:63"><span class="id" title="binder">Op<sub>2</sub></span></a>} (<a id="h<sub>1</sub>:64" class="idref" href="#h<sub>1</sub>:64"><span class="id" title="binder">h<sub>1</sub></span></a> : <a class="idref" href="Free.html#Op<sub>1</sub>:62"><span class="id" title="variable">Op<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) (<a id="h<sub>2</sub>:65" class="idref" href="#h<sub>2</sub>:65"><span class="id" title="binder">h<sub>2</sub></span></a> : <a class="idref" href="Free.html#Op<sub>2</sub>:63"><span class="id" title="variable">Op<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <a class="idref" href="Free.html#Op<sub>1</sub>:62"><span class="id" title="variable">Op<sub>1</sub></span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#Op<sub>2</sub>:63"><span class="id" title="variable">Op<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <a id="op:66" class="idref" href="#op:66"><span class="id" title="binder">op</span></a> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Free.html#op:66"><span class="id" title="variable">op</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inl"><span class="id" title="constructor">inl</span></a> <span class="id" title="var">op</span> ⇒ <a class="idref" href="Free.html#h<sub>1</sub>:64"><span class="id" title="variable">h<sub>1</sub></span></a> <a class="idref" href="Free.html#op:66"><span class="id" title="variable">op</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inr"><span class="id" title="constructor">inr</span></a> <span class="id" title="var">op</span> ⇒ <a class="idref" href="Free.html#h<sub>2</sub>:65"><span class="id" title="variable">h<sub>2</sub></span></a> <a class="idref" href="Free.html#op:66"><span class="id" title="variable">op</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Notation</span> <a id="7d4b45e01d2962fa1d56dbbc1c10fa<sub>82</sub>" class="idref" href="#7d4b45e01d2962fa1d56dbbc1c10fa<sub>82</sub>"><span class="id" title="notation">&quot;</span></a>h<sub>1</sub> ⊕ h<sub>2</sub>" := (<a class="idref" href="Free.html#FreeExpr.hsum"><span class="id" title="definition">hsum</span></a> <span class="id" title="var">h<sub>1</sub></span> <span class="id" title="var">h<sub>2</sub></span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10).<br/>
</div>

<div class="doc">
We hence can evaluate mixed expressions as well without any additional
 	 definitions 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.eval" class="idref" href="#FreeExpr.eval"><span class="id" title="definition">eval</span></a> := <a class="idref" href="Free.html#FreeExpr.fold_eval"><span class="id" title="definition">fold_eval</span></a> (<a class="idref" href="Free.html#FreeExpr.hplus"><span class="id" title="definition">hplus</span></a> <a class="idref" href="Free.html#7d4b45e01d2962fa1d56dbbc1c10fa<sub>82</sub>"><span class="id" title="notation">⊕</span></a> <a class="idref" href="Free.html#FreeExpr.hminus"><span class="id" title="definition">hminus</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e5" class="idref" href="#FreeExpr.e5"><span class="id" title="definition">e<sub>5</sub></span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> (<a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:68" class="idref" href="#x:68"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inr"><span class="id" title="constructor">inr</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 2 1))<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:69" class="idref" href="#y:69"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inr"><span class="id" title="constructor">inr</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 6 3))<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inl"><span class="id" title="constructor">inl</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> <a class="idref" href="Free.html#x:68"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#y:69"><span class="id" title="variable">y</span></a>)).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="Free.html#FreeExpr.e5"><span class="id" title="definition">e<sub>5</sub></span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">4</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab171"></a><h3 class="section">Using explicit <span class="inlinecode"><span class="id" title="var">inl</span></span> and <span class="inlinecode"><span class="id" title="var">inr</span></span> is painful, so...</h3>

<div class="paragraph"> </div>

 Writing computations got slightly worse however: we now need to carefully
tag our operations depending on their position in the signature. We alleviate
this pain by asking Coq to find these tags itself. 
</div>
<div class="code">

<span class="id" title="keyword">Class</span> <a id="FreeExpr.Subop" class="idref" href="#FreeExpr.Subop"><span class="id" title="inductive, record"><span id="FreeExpr.Subop" class="id">Subop</span></span></a> <a id="Op<sub>1</sub>:70" class="idref" href="#Op<sub>1</sub>:70"><span class="id" title="binder">Op<sub>1</sub></span></a> <a id="Op<sub>2</sub>:71" class="idref" href="#Op<sub>2</sub>:71"><span class="id" title="binder">Op<sub>2</sub></span></a> := <a id="FreeExpr.inject" class="idref" href="#FreeExpr.inject"><span class="id" title="constructor, projection"><span id="FreeExpr.inject" class="id">inject</span></span></a> : <a class="idref" href="Free.html#Op<sub>1</sub>:70"><span class="id" title="variable">Op<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#Op<sub>2</sub>:71"><span class="id" title="variable">Op<sub>2</sub></span></a>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <a id="FreeExpr.subop_refl" class="idref" href="#FreeExpr.subop_refl"><span class="id" title="instance">subop_refl</span></a> <a id="Op:74" class="idref" href="#Op:74"><span class="id" title="binder">Op</span></a> : <a class="idref" href="Free.html#FreeExpr.Subop"><span class="id" title="class">Subop</span></a> <a class="idref" href="Free.html#Op:74"><span class="id" title="variable">Op</span></a> <a class="idref" href="Free.html#Op:74"><span class="id" title="variable">Op</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <a id="x:75" class="idref" href="#x:75"><span class="id" title="binder">x</span></a> ⇒ <a class="idref" href="Free.html#x:75"><span class="id" title="variable">x</span></a>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <a id="FreeExpr.subop_left" class="idref" href="#FreeExpr.subop_left"><span class="id" title="instance">subop_left</span></a> <a id="Op<sub>1</sub>:76" class="idref" href="#Op<sub>1</sub>:76"><span class="id" title="binder">Op<sub>1</sub></span></a> <a id="Op<sub>2</sub>:77" class="idref" href="#Op<sub>2</sub>:77"><span class="id" title="binder">Op<sub>2</sub></span></a> :<br/>
&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.Subop"><span class="id" title="class">Subop</span></a> <a class="idref" href="Free.html#Op<sub>1</sub>:76"><span class="id" title="variable">Op<sub>1</sub></span></a> (<a class="idref" href="Free.html#Op<sub>1</sub>:76"><span class="id" title="variable">Op<sub>1</sub></span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#Op<sub>2</sub>:77"><span class="id" title="variable">Op<sub>2</sub></span></a>) := <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inl"><span class="id" title="constructor">inl</span></a>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <a id="FreeExpr.subop_right" class="idref" href="#FreeExpr.subop_right"><span class="id" title="instance">subop_right</span></a> <a id="Op<sub>1</sub>:78" class="idref" href="#Op<sub>1</sub>:78"><span class="id" title="binder">Op<sub>1</sub></span></a> <a id="Op<sub>2</sub>:79" class="idref" href="#Op<sub>2</sub>:79"><span class="id" title="binder">Op<sub>2</sub></span></a> <a id="Op<sub>3</sub>:80" class="idref" href="#Op<sub>3</sub>:80"><span class="id" title="binder">Op<sub>3</sub></span></a> `{<a id="H:81" class="idref" href="#H:81"><span class="id" title="binder">Subop</span></a> <a id="H:81" class="idref" href="#H:81"><span class="id" title="binder">Op<sub>1</sub></span></a> <a id="H:81" class="idref" href="#H:81"><span class="id" title="binder">Op<sub>3</sub></span></a>}<br/>
&nbsp;&nbsp;: <a class="idref" href="Free.html#FreeExpr.Subop"><span class="id" title="class">Subop</span></a> <a class="idref" href="Free.html#Op<sub>1</sub>:78"><span class="id" title="variable">Op<sub>1</sub></span></a> (<a class="idref" href="Free.html#Op<sub>2</sub>:79"><span class="id" title="variable">Op<sub>2</sub></span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#Op<sub>3</sub>:80"><span class="id" title="variable">Op<sub>3</sub></span></a>)<br/>
&nbsp;&nbsp;:= <span class="id" title="keyword">fun</span> <a id="e:82" class="idref" href="#e:82"><span class="id" title="binder">e</span></a> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#inr"><span class="id" title="constructor">inr</span></a> (<a class="idref" href="Free.html#FreeExpr.inject"><span class="id" title="definition">inject</span></a> <a class="idref" href="Free.html#e:82"><span class="id" title="variable">e</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="FreeExpr.trigger'" class="idref" href="#FreeExpr.trigger'"><span class="id" title="abbreviation">trigger'</span></a> <span class="id" title="var">e</span> := (<a class="idref" href="Free.html#FreeExpr.trigger"><span class="id" title="definition">trigger</span></a> (<a class="idref" href="Free.html#FreeExpr.inject"><span class="id" title="definition">inject</span></a> <span class="id" title="var">e</span>)).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e5'" class="idref" href="#FreeExpr.e5'"><span class="id" title="definition">e<sub>5</sub>'</span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> (<a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:83" class="idref" href="#x:83"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger'"><span class="id" title="abbreviation">trigger'</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 2 1)<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:84" class="idref" href="#y:84"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.trigger'"><span class="id" title="abbreviation">trigger'</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> 6 3)<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.trigger'"><span class="id" title="abbreviation">trigger'</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> <a class="idref" href="Free.html#x:83"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#y:84"><span class="id" title="variable">y</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<a class="idref" href="Free.html#FreeExpr.eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="Free.html#FreeExpr.e5'"><span class="id" title="definition">e<sub>5</sub>'</span></a>).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">4</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 And finally with a little bit of additional notations,
   we get an acceptable syntax 
</div>
<div class="code">
<span class="id" title="keyword">Notation</span> <a id="FreeExpr.add'" class="idref" href="#FreeExpr.add'"><span class="id" title="abbreviation">add'</span></a> <span class="id" title="var">n</span> <span class="id" title="var">m</span> := (<a class="idref" href="Free.html#FreeExpr.trigger'"><span class="id" title="abbreviation">trigger'</span></a> (<a class="idref" href="Free.html#FreeExpr.add"><span class="id" title="constructor">add</span></a> <span class="id" title="var">n</span> <span class="id" title="var">m</span>)).<br/>
<span class="id" title="keyword">Notation</span> <a id="FreeExpr.sub'" class="idref" href="#FreeExpr.sub'"><span class="id" title="abbreviation">sub'</span></a> <span class="id" title="var">n</span> <span class="id" title="var">m</span> := (<a class="idref" href="Free.html#FreeExpr.trigger'"><span class="id" title="abbreviation">trigger'</span></a> (<a class="idref" href="Free.html#FreeExpr.sub"><span class="id" title="constructor">sub</span></a> <span class="id" title="var">n</span> <span class="id" title="var">m</span>)).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e5''" class="idref" href="#FreeExpr.e5''"><span class="id" title="definition">e<sub>5</sub>''</span></a> : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> (<a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:85" class="idref" href="#x:85"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.sub'"><span class="id" title="abbreviation">sub'</span></a> 2 1<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:86" class="idref" href="#y:86"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#FreeExpr.sub'"><span class="id" title="abbreviation">sub'</span></a> 6 3<a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.add'"><span class="id" title="abbreviation">add'</span></a> <a class="idref" href="Free.html#x:85"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#y:86"><span class="id" title="variable">y</span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#FreeExpr.eval"><span class="id" title="definition">eval</span></a> <a class="idref" href="Free.html#FreeExpr.e5''"><span class="id" title="definition">e<sub>5</sub>''</span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">4</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

 Note that, instead of seeing <span class="inlinecode"><span class="id" title="var">Expr</span></span> <span class="inlinecode"><span class="id" title="var">Op</span></span> as our programming language itself,
   we can see it alternatively as a <i>semantic domain</i> for our original syntax.

</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <a id="FreeExpr.ExprAST" class="idref" href="#FreeExpr.ExprAST"><span class="id" title="definition, inductive"><span id="FreeExpr.ExprAST_rect" class="id"><span id="FreeExpr.ExprAST_ind" class="id"><span id="FreeExpr.ExprAST_rec" class="id"><span id="FreeExpr.ExprAST_sind" class="id">ExprAST</span></span></span></span></span></a> : <span class="id" title="keyword">Set</span> :=<br/>
| <a id="FreeExpr.ValAST" class="idref" href="#FreeExpr.ValAST"><span class="id" title="constructor">ValAST</span></a> (<a id="n:89" class="idref" href="#n:89"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>)<br/>
| <a id="FreeExpr.AddAST" class="idref" href="#FreeExpr.AddAST"><span class="id" title="constructor">AddAST</span></a> (<a id="e<sub>1</sub>:90" class="idref" href="#e<sub>1</sub>:90"><span class="id" title="binder">e<sub>1</sub></span></a> <a id="e<sub>2</sub>:91" class="idref" href="#e<sub>2</sub>:91"><span class="id" title="binder">e<sub>2</sub></span></a> : <a class="idref" href="Free.html#ExprAST:87"><span class="id" title="inductive">ExprAST</span></a>)<br/>
| <a id="FreeExpr.MinusAST" class="idref" href="#FreeExpr.MinusAST"><span class="id" title="constructor">MinusAST</span></a> (<a id="e<sub>1</sub>:92" class="idref" href="#e<sub>1</sub>:92"><span class="id" title="binder">e<sub>1</sub></span></a> <a id="e<sub>2</sub>:93" class="idref" href="#e<sub>2</sub>:93"><span class="id" title="binder">e<sub>2</sub></span></a> : <a class="idref" href="Free.html#ExprAST:87"><span class="id" title="inductive">ExprAST</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="FreeExpr.repr" class="idref" href="#FreeExpr.repr"><span class="id" title="definition">repr</span></a> (<a id="e:94" class="idref" href="#e:94"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#FreeExpr.ExprAST"><span class="id" title="inductive">ExprAST</span></a>) : <a class="idref" href="Free.html#FreeExpr.Expr"><span class="id" title="inductive">Expr</span></a> (<a class="idref" href="Free.html#FreeExpr.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#8abdb7f3ab648ea00240dde64faec549"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#FreeExpr.Minus"><span class="id" title="inductive">Minus</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#e:94"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.ValAST"><span class="id" title="constructor">ValAST</span></a> <span class="id" title="var">n</span> ⇒ <a class="idref" href="Free.html#FreeExpr.Val"><span class="id" title="constructor">Val</span></a> <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.AddAST"><span class="id" title="constructor">AddAST</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:97" class="idref" href="#x:97"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#repr:95"><span class="id" title="definition">repr</span></a> <span class="id" title="var">e<sub>1</sub></span><a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:98" class="idref" href="#y:98"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#repr:95"><span class="id" title="definition">repr</span></a> <span class="id" title="var">e<sub>2</sub></span><a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.add'"><span class="id" title="abbreviation">add'</span></a> <a class="idref" href="Free.html#x:97"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#y:98"><span class="id" title="variable">y</span></a><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#FreeExpr.MinusAST"><span class="id" title="constructor">MinusAST</span></a> <span class="id" title="var">e<sub>1</sub></span> <span class="id" title="var">e<sub>2</sub></span> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="x:99" class="idref" href="#x:99"><span class="id" title="binder">x</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#repr:95"><span class="id" title="definition">repr</span></a> <span class="id" title="var">e<sub>1</sub></span><a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a id="y:100" class="idref" href="#y:100"><span class="id" title="binder">y</span></a> <a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#repr:95"><span class="id" title="definition">repr</span></a> <span class="id" title="var">e<sub>2</sub></span><a class="idref" href="Free.html#b3068acea810c4971f3ce524b4cadeb3"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.sub'"><span class="id" title="abbreviation">sub'</span></a> <a class="idref" href="Free.html#x:99"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#y:100"><span class="id" title="variable">y</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
<span class="id" title="keyword">Definition</span> <a id="FreeExpr.sem" class="idref" href="#FreeExpr.sem"><span class="id" title="definition">sem</span></a> (<a id="e:101" class="idref" href="#e:101"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#FreeExpr.ExprAST"><span class="id" title="inductive">ExprAST</span></a>) : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> := <a class="idref" href="Free.html#FreeExpr.eval"><span class="id" title="definition">eval</span></a> (<a class="idref" href="Free.html#FreeExpr.repr"><span class="id" title="definition">repr</span></a> <a class="idref" href="Free.html#e:101"><span class="id" title="variable">e</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Example</span> <a id="FreeExpr.e6" class="idref" href="#FreeExpr.e6"><span class="id" title="definition">e<sub>6</sub></span></a> : <a class="idref" href="Free.html#FreeExpr.ExprAST"><span class="id" title="inductive">ExprAST</span></a> :=<br/>
&nbsp;&nbsp;<a class="idref" href="Free.html#FreeExpr.MinusAST"><span class="id" title="constructor">MinusAST</span></a> (<a class="idref" href="Free.html#FreeExpr.AddAST"><span class="id" title="constructor">AddAST</span></a> (<a class="idref" href="Free.html#FreeExpr.ValAST"><span class="id" title="constructor">ValAST</span></a> 3) (<a class="idref" href="Free.html#FreeExpr.ValAST"><span class="id" title="constructor">ValAST</span></a> 4)) (<a class="idref" href="Free.html#FreeExpr.ValAST"><span class="id" title="constructor">ValAST</span></a> 5).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<a class="idref" href="Free.html#FreeExpr.sem"><span class="id" title="definition">sem</span></a> <a class="idref" href="Free.html#FreeExpr.e6"><span class="id" title="definition">e<sub>6</sub></span></a>).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">2</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
</div>

<div class="doc">
<a id="lab172"></a><h2 class="section">Free Monads</h2>

<div class="paragraph"> </div>

 While our datatype <span class="inlinecode"><span class="id" title="var">Expr</span></span> worked out, it is rather specific: we can extend
our language, but only with operations whose meaning can be captured by a <span class="inlinecode"><span class="id" title="var">nat</span></span>:
this is encapsulated by the fact that the continuation to the <span class="inlinecode"><span class="id" title="var">Do</span></span> constructor
expects a <span class="inlinecode"><span class="id" title="var">nat</span></span>.  Of course a language that goes beyond a simple calculator
performs operations of all sorts of different nature.

<div class="paragraph"> </div>

We therefore generalize our approach by asking the operations to statically
specify what kind of answer they expect from the environment: <span class="inlinecode"><span class="id" title="var">E</span></span> is now a
family of types.  Furthermore, we also allow for computations returning other
values than <span class="inlinecode"><span class="id" title="var">nat</span></span>s.  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="Free.FFree" class="idref" href="#Free.FFree"><span class="id" title="definition, inductive"><span id="Free.FFree_rect" class="id"><span id="Free.FFree_ind" class="id"><span id="Free.FFree_rec" class="id"><span id="Free.FFree_sind" class="id">FFree</span></span></span></span></span></a> (<a id="E:102" class="idref" href="#E:102"><span class="id" title="binder">E</span></a> : <span class="id" title="keyword">Type</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Type</span>) (<a id="R:103" class="idref" href="#R:103"><span class="id" title="binder">R</span></a> : <span class="id" title="keyword">Type</span>) : <span class="id" title="keyword">Type</span> :=<br/>
| <a id="Free.Ret" class="idref" href="#Free.Ret"><span class="id" title="constructor">Ret</span></a> (<a id="x:106" class="idref" href="#x:106"><span class="id" title="binder">x</span></a> : <a class="idref" href="Free.html#R:103"><span class="id" title="variable">R</span></a>)<br/>
| <a id="Free.Do" class="idref" href="#Free.Do"><span class="id" title="constructor">Do</span></a> {<a id="X:107" class="idref" href="#X:107"><span class="id" title="binder">X</span></a>} (<a id="op:108" class="idref" href="#op:108"><span class="id" title="binder">op</span></a> : <a class="idref" href="Free.html#E:102"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#X:107"><span class="id" title="variable">X</span></a>) (<a id="k:109" class="idref" href="#k:109"><span class="id" title="binder">k</span></a> : <a class="idref" href="Free.html#X:107"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#FFree:104"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:102"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#R:103"><span class="id" title="variable">R</span></a>).<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
Note that <span class="inlinecode"><span class="id" title="var">op</span></span> is now characterized by an indexed type <span class="inlinecode"><span class="id" title="var">E</span></span>, and <span class="inlinecode"><span class="id" title="var">op</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">X</span></span>
means that, semantically, <span class="inlinecode"><span class="id" title="var">op</span></span> produces an <span class="inlinecode"><span class="id" title="var">X</span></span> (which will be fed to the
continuation <span class="inlinecode"><span class="id" title="var">k</span></span>).

<div class="paragraph"> </div>

<a id="lab173"></a><h3 class="section">Operations, dependently</h3>

<div class="paragraph"> </div>

 In this format, the signature of the addition operation looks like the following: 
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <a id="Free.Plus" class="idref" href="#Free.Plus"><span class="id" title="definition, inductive"><span id="Free.Plus_rect" class="id"><span id="Free.Plus_ind" class="id"><span id="Free.Plus_rec" class="id"><span id="Free.Plus_sind" class="id">Plus</span></span></span></span></span></a> : <span class="id" title="keyword">Type</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;<a id="Free.add" class="idref" href="#Free.add"><span class="id" title="constructor">add</span></a> (<a id="n<sub>1</sub>:112" class="idref" href="#n<sub>1</sub>:112"><span class="id" title="binder">n<sub>1</sub></span></a> <a id="n<sub>2</sub>:113" class="idref" href="#n<sub>2</sub>:113"><span class="id" title="binder">n<sub>2</sub></span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) : <a class="idref" href="Free.html#Plus:110"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>.<br/>
</div>

<div class="doc">
Or, for Boolean operations:  
</div>
<div class="code">
<span class="id" title="keyword">Inductive</span> <a id="Free.BoolOp" class="idref" href="#Free.BoolOp"><span class="id" title="definition, inductive"><span id="Free.BoolOp_rect" class="id"><span id="Free.BoolOp_ind" class="id"><span id="Free.BoolOp_rec" class="id"><span id="Free.BoolOp_sind" class="id">BoolOp</span></span></span></span></span></a> : <span class="id" title="keyword">Type</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Type</span> :=<br/>
| <a id="Free.or" class="idref" href="#Free.or"><span class="id" title="constructor">or</span></a>  (<a id="b<sub>1</sub>:116" class="idref" href="#b<sub>1</sub>:116"><span class="id" title="binder">b<sub>1</sub></span></a> <a id="b<sub>2</sub>:117" class="idref" href="#b<sub>2</sub>:117"><span class="id" title="binder">b<sub>2</sub></span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>) : <a class="idref" href="Free.html#BoolOp:114"><span class="id" title="inductive">BoolOp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a><br/>
| <a id="Free.not" class="idref" href="#Free.not"><span class="id" title="constructor">not</span></a> (<a id="b:118" class="idref" href="#b:118"><span class="id" title="binder">b</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>) : <a class="idref" href="Free.html#BoolOp:114"><span class="id" title="inductive">BoolOp</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>.<br/>
</div>

<div class="doc">
The implementation of an operation is now aware of the type it must implement. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="Free.hplus" class="idref" href="#Free.hplus"><span class="id" title="definition">hplus</span></a> : <span class="id" title="keyword">∀</span> <a id="X:119" class="idref" href="#X:119"><span class="id" title="binder">X</span></a>, <a class="idref" href="Free.html#Free.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#X:119"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#X:119"><span class="id" title="variable">X</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> '(<a id="pat:122" class="idref" href="#pat:122"><span class="id" title="binder">add</span></a> <a id="n<sub>1</sub>:121" class="idref" href="#n<sub>1</sub>:121"><span class="id" title="binder"><span id="pat:122" class="id">n<sub>1</sub></span></span></a> <a id="n<sub>2</sub>:120" class="idref" href="#n<sub>2</sub>:120"><span class="id" title="binder"><span id="pat:122" class="id">n<sub>2</sub></span></span></a>) ⇒ <a class="idref" href="Free.html#n<sub>1</sub>:121"><span class="id" title="variable">n<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Nat.html#0dacc1786c5ba797d47dd85006231633"><span class="id" title="notation">+</span></a> <a class="idref" href="Free.html#n<sub>2</sub>:120"><span class="id" title="variable">n<sub>2</sub></span></a>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Definition</span> <a id="Free.hbool" class="idref" href="#Free.hbool"><span class="id" title="definition">hbool</span></a> : <span class="id" title="keyword">∀</span> <a id="X:123" class="idref" href="#X:123"><span class="id" title="binder">X</span></a>, <a class="idref" href="Free.html#Free.BoolOp"><span class="id" title="inductive">BoolOp</span></a> <a class="idref" href="Free.html#X:123"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#X:123"><span class="id" title="variable">X</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <a id="op:124" class="idref" href="#op:124"><span class="id" title="binder">op</span></a> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Free.html#op:124"><span class="id" title="variable">op</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.or"><span class="id" title="constructor">or</span></a> <span class="id" title="var">b<sub>1</sub></span> <span class="id" title="var">b<sub>2</sub></span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#orb"><span class="id" title="definition">orb</span></a> <span class="id" title="var">b<sub>1</sub></span> <span class="id" title="var">b<sub>2</sub></span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.not"><span class="id" title="constructor">not</span></a> <span class="id" title="var">b</span> ⇒ <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#negb"><span class="id" title="definition">negb</span></a> <span class="id" title="var">b</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Fixpoint</span> <a id="Free.fold_pure" class="idref" href="#Free.fold_pure"><span class="id" title="definition">fold_pure</span></a> {<a id="E:126" class="idref" href="#E:126"><span class="id" title="binder">E</span></a> <a id="R:127" class="idref" href="#R:127"><span class="id" title="binder">R</span></a>} (<a id="h:129" class="idref" href="#h:129"><span class="id" title="binder">h</span></a> : <span class="id" title="keyword">∀</span> <a id="X:128" class="idref" href="#X:128"><span class="id" title="binder">X</span></a>, <a class="idref" href="Free.html#E:126"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#X:128"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#X:128"><span class="id" title="variable">X</span></a>) (<a id="t:130" class="idref" href="#t:130"><span class="id" title="binder">t</span></a> : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:126"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#R:127"><span class="id" title="variable">R</span></a>) : <a class="idref" href="Free.html#R:127"><span class="id" title="variable">R</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#t:130"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <span class="id" title="var">x</span> ⇒ <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> <span class="id" title="var">k</span> ⇒ <a class="idref" href="Free.html#fold_pure:131"><span class="id" title="definition">fold_pure</span></a> <a class="idref" href="Free.html#h:129"><span class="id" title="variable">h</span></a> (<span class="id" title="var">k</span> (<a class="idref" href="Free.html#h:129"><span class="id" title="variable">h</span></a> <span class="id" title="var">_</span> <span class="id" title="var">op</span>))<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
We can rebuild the machinery from before, but this time <span class="inlinecode"><span class="id" title="var">seq</span></span> <i>is</i> the <span class="inlinecode"><span class="id" title="var">bind</span></span> of a monad <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span>. 
</div>
<div class="code">
<span class="id" title="keyword">Fixpoint</span> <a id="Free.seq" class="idref" href="#Free.seq"><span class="id" title="definition">seq</span></a> {<a id="E:133" class="idref" href="#E:133"><span class="id" title="binder">E</span></a> <a id="X:134" class="idref" href="#X:134"><span class="id" title="binder">X</span></a> <a id="Y:135" class="idref" href="#Y:135"><span class="id" title="binder">Y</span></a>} (<a id="e:136" class="idref" href="#e:136"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:133"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#X:134"><span class="id" title="variable">X</span></a>) (<a id="k:137" class="idref" href="#k:137"><span class="id" title="binder">k</span></a> : <a class="idref" href="Free.html#X:134"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:133"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#Y:135"><span class="id" title="variable">Y</span></a>) : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:133"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#Y:135"><span class="id" title="variable">Y</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#e:136"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <span class="id" title="var">x</span>   ⇒ <a class="idref" href="Free.html#k:137"><span class="id" title="variable">k</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> <span class="id" title="var">h</span> ⇒ <a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> (<span class="id" title="keyword">fun</span> <a id="n:140" class="idref" href="#n:140"><span class="id" title="binder">n</span></a> ⇒ <a class="idref" href="Free.html#seq:138"><span class="id" title="definition">seq</span></a> (<span class="id" title="var">h</span> <a class="idref" href="Free.html#n:140"><span class="id" title="variable">n</span></a>) <a class="idref" href="Free.html#k:137"><span class="id" title="variable">k</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">export</span>] <span class="id" title="keyword">Instance</span> <a id="Free.FFreeM" class="idref" href="#Free.FFreeM"><span class="id" title="instance">FFreeM</span></a> {<a id="E:141" class="idref" href="#E:141"><span class="id" title="binder">E</span></a>} : <a class="idref" href="Monads.html#Monad.Monad"><span class="id" title="class">Monad</span></a> (<a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:141"><span class="id" title="variable">E</span></a>) :=<br/>
{|<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Monads.html#Monad.ret"><span class="id" title="method">ret</span></a> := @<a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <span class="id" title="var">E</span><br/>
&nbsp;&nbsp;; <a class="idref" href="Monads.html#Monad.bind"><span class="id" title="method">bind</span></a> := @<a class="idref" href="Free.html#Free.seq"><span class="id" title="definition">seq</span></a> <span class="id" title="var">E</span><br/>
|}.<br/>
</div>

<div class="doc">
<a id="lab174"></a><h3 class="section">Equivalence of <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> computations</h3>

<div class="paragraph"> </div>

 We define an appropriate notion of equivalence.

<div class="paragraph"> </div>

Note that the continuations are required to be <i>extensionally equivalent</i>.  
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="Free.eq_FFree" class="idref" href="#Free.eq_FFree"><span class="id" title="definition, inductive"><span id="Free.eq_FFree_ind" class="id"><span id="Free.eq_FFree_sind" class="id">eq_FFree</span></span></span></a> {<a id="E:142" class="idref" href="#E:142"><span class="id" title="binder">E</span></a> <a id="X:143" class="idref" href="#X:143"><span class="id" title="binder">X</span></a>} : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <span class="id" title="var">E</span> <span class="id" title="var">X</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <span class="id" title="var">E</span> <span class="id" title="var">X</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Prop</span> :=<br/>
| <a id="Free.eq_Ret" class="idref" href="#Free.eq_Ret"><span class="id" title="constructor">eq_Ret</span></a> : <span class="id" title="keyword">∀</span> (<a id="x:146" class="idref" href="#x:146"><span class="id" title="binder">x</span></a>:<a class="idref" href="Free.html#X:143"><span class="id" title="variable">X</span></a>), <a class="idref" href="Free.html#eq_FFree:144"><span class="id" title="inductive">eq_FFree</span></a> (<a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <a class="idref" href="Free.html#x:146"><span class="id" title="variable">x</span></a>) (<a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <a class="idref" href="Free.html#x:146"><span class="id" title="variable">x</span></a>)<br/>
| <a id="Free.eq_Do" class="idref" href="#Free.eq_Do"><span class="id" title="constructor">eq_Do</span></a>  : <span class="id" title="keyword">∀</span> {<a id="Y:147" class="idref" href="#Y:147"><span class="id" title="binder">Y</span></a>} (<a id="op:148" class="idref" href="#op:148"><span class="id" title="binder">op</span></a> : <a class="idref" href="Free.html#E:142"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#Y:147"><span class="id" title="variable">Y</span></a>) (<a id="k<sub>1</sub>:149" class="idref" href="#k<sub>1</sub>:149"><span class="id" title="binder">k<sub>1</sub></span></a> <a id="k<sub>2</sub>:150" class="idref" href="#k<sub>2</sub>:150"><span class="id" title="binder">k<sub>2</sub></span></a> : <a class="idref" href="Free.html#Y:147"><span class="id" title="variable">Y</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:142"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#X:143"><span class="id" title="variable">X</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<a id="Heq:153" class="idref" href="#Heq:153"><span class="id" title="binder">Heq</span></a>: <span class="id" title="keyword">∀</span> (<a id="y<sub>1</sub>:151" class="idref" href="#y<sub>1</sub>:151"><span class="id" title="binder">y<sub>1</sub></span></a> <a id="y<sub>2</sub>:152" class="idref" href="#y<sub>2</sub>:152"><span class="id" title="binder">y<sub>2</sub></span></a>:<a class="idref" href="Free.html#Y:147"><span class="id" title="variable">Y</span></a>), <a class="idref" href="Free.html#y<sub>1</sub>:151"><span class="id" title="variable">y<sub>1</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#6cd0f7b28b6092304087c7049437bb1a"><span class="id" title="notation">=</span></a> <a class="idref" href="Free.html#y<sub>2</sub>:152"><span class="id" title="variable">y<sub>2</sub></span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#eq_FFree:144"><span class="id" title="inductive">eq_FFree</span></a> (<a class="idref" href="Free.html#k<sub>1</sub>:149"><span class="id" title="variable">k<sub>1</sub></span></a> <a class="idref" href="Free.html#y<sub>1</sub>:151"><span class="id" title="variable">y<sub>1</sub></span></a>) (<a class="idref" href="Free.html#k<sub>2</sub>:150"><span class="id" title="variable">k<sub>2</sub></span></a> <a class="idref" href="Free.html#y<sub>2</sub>:152"><span class="id" title="variable">y<sub>2</sub></span></a>)),<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#eq_FFree:144"><span class="id" title="inductive">eq_FFree</span></a> (<a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <a class="idref" href="Free.html#op:148"><span class="id" title="variable">op</span></a> <a class="idref" href="Free.html#k<sub>1</sub>:149"><span class="id" title="variable">k<sub>1</sub></span></a>) (<a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <a class="idref" href="Free.html#op:148"><span class="id" title="variable">op</span></a> <a class="idref" href="Free.html#k<sub>2</sub>:150"><span class="id" title="variable">k<sub>2</sub></span></a>).<br/>
</div>

<div class="doc">
Use straightforward induction to prove that <span class="inlinecode"><span class="id" title="var">eq_FFree</span></span> is an equivalence relation.  The only wrinkle is that, due to the existential type for the return
of <span class="inlinecode"><span class="id" title="var">op</span></span> in the <span class="inlinecode"><span class="id" title="var">Do</span></span> constructor, we need to use <span class="inlinecode"><span class="id" title="var">inj_pair2</span></span>, which lets us extract
information about the equality of the components of types of the form <span class="inlinecode"><span class="id" title="var">existT</span></span> <span class="inlinecode"><span class="id" title="var">P</span></span> <span class="inlinecode"><span class="id" title="var">X</span></span> <span class="inlinecode"><span class="id" title="var">v</span></span>.  
</div>
<div class="code">

#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <a id="Free.eqM_FFree" class="idref" href="#Free.eqM_FFree"><span class="id" title="instance">eqM_FFree</span></a> {<a id="E:160" class="idref" href="#E:160"><span class="id" title="binder">E</span></a>} : <a class="idref" href="Monads.html#MonadLawsEqM.EqM"><span class="id" title="class">EqM</span></a> (<a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:160"><span class="id" title="variable">E</span></a>) :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <a id="A:161" class="idref" href="#A:161"><span class="id" title="binder">A</span></a> ⇒ (@<a class="idref" href="Free.html#Free.eq_FFree"><span class="id" title="inductive">eq_FFree</span></a> <span class="id" title="var">E</span> <a class="idref" href="Free.html#A:161"><span class="id" title="variable">A</span></a>).<br/><hr class='doublespaceincode'/>
#[<span class="id" title="var">local</span>] <span class="id" title="keyword">Instance</span> <a id="Free.eqM_FFree_Equiv" class="idref" href="#Free.eqM_FFree_Equiv"><span class="id" title="instance">eqM_FFree_Equiv</span></a> {<a id="E:162" class="idref" href="#E:162"><span class="id" title="binder">E</span></a>} : <a class="idref" href="Monads.html#MonadLawsEqM.EqMEquivalence"><span class="id" title="class">EqMEquivalence</span></a> (<a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:162"><span class="id" title="variable">E</span></a>).<br/>
<div class="togglescript" id="proofcontrol1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')"><span class="show"></span></div>
<div class="proofscript" id="proof1" onclick="toggleDisplay('proof1');toggleDisplay('proofcontrol1')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>; <span class="id" title="var">typeclasses</span> <span class="id" title="tactic">eauto</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a id="lab175"></a><h3 class="section">Monad Laws for <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> :</h3>

<div class="paragraph"> </div>

 Next we prove the monad laws, but they follow straightforwardly by
induction: 
</div>
<div class="code">
#[<span class="id" title="var">local</span>]  <span class="id" title="keyword">Instance</span> <a id="Free.eqm_FFree_monad_laws" class="idref" href="#Free.eqm_FFree_monad_laws"><span class="id" title="instance">eqm_FFree_monad_laws</span></a> {<a id="E:163" class="idref" href="#E:163"><span class="id" title="binder">E</span></a>} : <a class="idref" href="Monads.html#MonadLawsEqM.MonadLaws"><span class="id" title="class">MonadLaws</span></a> (<a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:163"><span class="id" title="variable">E</span></a>).<br/>
<div class="togglescript" id="proofcontrol2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')"><span class="show"></span></div>
<div class="proofscript" id="proof2" onclick="toggleDisplay('proof2');toggleDisplay('proofcontrol2')">
<span class="id" title="keyword">Proof</span>.<br/>
&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span> <span class="id" title="var">C</span> <span class="id" title="var">ma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">ma</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">rewrite</span> <span class="id" title="var">H</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span> <span class="id" title="var">C</span> <span class="id" title="var">ma</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">intros</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">m</span>; <span class="id" title="tactic">intros</span>; <span class="id" title="tactic">simpl</span> <span class="id" title="keyword">in</span> ×.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">constructor</span>. <span class="id" title="tactic">intros</span>. <span class="id" title="tactic">subst</span>. <span class="id" title="tactic">rewrite</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;- <span class="id" title="tactic">repeat</span> <span class="id" title="tactic">red</span>. <span class="id" title="tactic">intros</span> <span class="id" title="var">A</span> <span class="id" title="var">B</span> <span class="id" title="var">x</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">induction</span> <span class="id" title="var">x</span>; <span class="id" title="tactic">intros</span> <span class="id" title="var">y</span> <span class="id" title="var">Heq</span> <span class="id" title="var">k<sub>1</sub></span> <span class="id" title="var">k<sub>2</sub></span> <span class="id" title="var">HK</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">inversion</span> <span class="id" title="var">Heq</span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">apply</span> <span class="id" title="var">HK</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;+ <span class="id" title="tactic">inversion</span> <span class="id" title="var">Heq</span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Logic.Eqdep.html#EqdepTheory.inj_pair2"><span class="id" title="lemma">inj_pair2</span></a> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>2</sub></span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Logic.Eqdep.html#EqdepTheory.inj_pair2"><span class="id" title="lemma">inj_pair2</span></a> <span class="id" title="keyword">in</span> <span class="id" title="var">H<sub>3</sub></span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">constructor</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">intros</span>. <span class="id" title="tactic">subst</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">apply</span> <span class="id" title="var">H</span>. <span class="id" title="tactic">apply</span> <span class="id" title="var">Heq0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">simpl</span>. <span class="id" title="tactic">reflexivity</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="tactic">assumption</span>.<br/>
<span class="id" title="keyword">Qed</span>.<br/>
</div>
</div>

<div class="doc">
<a id="lab176"></a><h3 class="section">Disjoint sum of Indexed Types</h3>

<div class="paragraph"> </div>

 Now that our operation types are indexed by their return types, we need to
provide an appropriate notion of "disjoint union": 
</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="Free.sumi" class="idref" href="#Free.sumi"><span class="id" title="definition, inductive"><span id="Free.sumi_rect" class="id"><span id="Free.sumi_ind" class="id"><span id="Free.sumi_rec" class="id"><span id="Free.sumi_sind" class="id">sumi</span></span></span></span></span></a> (<a id="E<sub>1</sub>:164" class="idref" href="#E<sub>1</sub>:164"><span class="id" title="binder">E<sub>1</sub></span></a> <a id="E<sub>2</sub>:165" class="idref" href="#E<sub>2</sub>:165"><span class="id" title="binder">E<sub>2</sub></span></a> : <span class="id" title="keyword">Type</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Type</span>) (<a id="X:166" class="idref" href="#X:166"><span class="id" title="binder">X</span></a> : <span class="id" title="keyword">Type</span>) : <span class="id" title="keyword">Type</span> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a id="Free.inli" class="idref" href="#Free.inli"><span class="id" title="constructor">inli</span></a> (<span class="id" title="var">_</span> : <a class="idref" href="Free.html#E<sub>1</sub>:164"><span class="id" title="variable">E<sub>1</sub></span></a> <a class="idref" href="Free.html#X:166"><span class="id" title="variable">X</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a id="Free.inri" class="idref" href="#Free.inri"><span class="id" title="constructor">inri</span></a> (<span class="id" title="var">_</span> : <a class="idref" href="Free.html#E<sub>2</sub>:165"><span class="id" title="variable">E<sub>2</sub></span></a> <a class="idref" href="Free.html#X:166"><span class="id" title="variable">X</span></a>).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Notation</span> <a id="2c3369f05bd69871759ee07195700b<sub>20</sub>" class="idref" href="#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">&quot;</span></a>Op<sub>1</sub> +' Op<sub>2</sub>" := (<a class="idref" href="Free.html#Free.sumi"><span class="id" title="inductive">sumi</span></a> <span class="id" title="var">Op<sub>1</sub></span> <span class="id" title="var">Op<sub>2</sub></span>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 10).<br/>
</div>

<div class="doc">
We can also "sum" <i>handlers</i>: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="Free.hpure_sum" class="idref" href="#Free.hpure_sum"><span class="id" title="definition">hpure_sum</span></a> {<a id="Op<sub>1</sub>:169" class="idref" href="#Op<sub>1</sub>:169"><span class="id" title="binder">Op<sub>1</sub></span></a> <a id="Op<sub>2</sub>:170" class="idref" href="#Op<sub>2</sub>:170"><span class="id" title="binder">Op<sub>2</sub></span></a>} (<a id="h<sub>1</sub>:172" class="idref" href="#h<sub>1</sub>:172"><span class="id" title="binder">h<sub>1</sub></span></a> : <span class="id" title="keyword">∀</span> <a id="X:171" class="idref" href="#X:171"><span class="id" title="binder">X</span></a>, <a class="idref" href="Free.html#Op<sub>1</sub>:169"><span class="id" title="variable">Op<sub>1</sub></span></a> <a class="idref" href="Free.html#X:171"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#X:171"><span class="id" title="variable">X</span></a>) (<a id="h<sub>2</sub>:174" class="idref" href="#h<sub>2</sub>:174"><span class="id" title="binder">h<sub>2</sub></span></a> : <span class="id" title="keyword">∀</span> <a id="X:173" class="idref" href="#X:173"><span class="id" title="binder">X</span></a>, <a class="idref" href="Free.html#Op<sub>2</sub>:170"><span class="id" title="variable">Op<sub>2</sub></span></a> <a class="idref" href="Free.html#X:173"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#X:173"><span class="id" title="variable">X</span></a>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;: <span class="id" title="keyword">∀</span> <a id="X:175" class="idref" href="#X:175"><span class="id" title="binder">X</span></a>, <a class="idref" href="Free.html#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">(</span></a><a class="idref" href="Free.html#Op<sub>1</sub>:169"><span class="id" title="variable">Op<sub>1</sub></span></a> <a class="idref" href="Free.html#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#Op<sub>2</sub>:170"><span class="id" title="variable">Op<sub>2</sub></span></a><a class="idref" href="Free.html#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">)</span></a> <a class="idref" href="Free.html#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <a class="idref" href="Free.html#X:175"><span class="id" title="variable">X</span></a> :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <a id="op:176" class="idref" href="#op:176"><span class="id" title="binder">op</span></a> ⇒ <span class="id" title="keyword">match</span> <a class="idref" href="Free.html#op:176"><span class="id" title="variable">op</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.inli"><span class="id" title="constructor">inli</span></a> <span class="id" title="var">op</span> ⇒ <a class="idref" href="Free.html#h<sub>1</sub>:172"><span class="id" title="variable">h<sub>1</sub></span></a> <span class="id" title="var">_</span> <a class="idref" href="Free.html#op:176"><span class="id" title="variable">op</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.inri"><span class="id" title="constructor">inri</span></a> <span class="id" title="var">op</span> ⇒ <a class="idref" href="Free.html#h<sub>2</sub>:174"><span class="id" title="variable">h<sub>2</sub></span></a> <span class="id" title="var">_</span> <a class="idref" href="Free.html#op:176"><span class="id" title="variable">op</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
<a id="lab177"></a><h3 class="section">Implicit injections</h3>
 And, using similar typeclass machinery to what we saw previously,
use inference to <span class="inlinecode"><span class="id" title="var">inject</span></span> an <span class="inlinecode"><span class="id" title="var">op</span></span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">E</span></span> <span class="inlinecode"><span class="id" title="var">X</span></span> into, e.g., a sum <span class="inlinecode">(<span class="id" title="var">E</span></span> <span class="inlinecode">+'</span> <span class="inlinecode"><span class="id" title="var">F</span>)</span> <span class="inlinecode"><span class="id" title="var">X</span></span>.    
</div>

<div class="doc">
Which allows us to define a generic <span class="inlinecode"><span class="id" title="var">trigger</span></span> operation: 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="Free.trigger_" class="idref" href="#Free.trigger_"><span class="id" title="definition">trigger_</span></a> {<a id="E:194" class="idref" href="#E:194"><span class="id" title="binder">E</span></a> <a id="X:195" class="idref" href="#X:195"><span class="id" title="binder">X</span></a>} (<a id="e:196" class="idref" href="#e:196"><span class="id" title="binder">e</span></a> : <a class="idref" href="Free.html#E:194"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#X:195"><span class="id" title="variable">X</span></a>) :=<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <a class="idref" href="Free.html#e:196"><span class="id" title="variable">e</span></a> (<span class="id" title="keyword">fun</span> <a id="x:197" class="idref" href="#x:197"><span class="id" title="binder">x</span></a> ⇒ <a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <a class="idref" href="Free.html#x:197"><span class="id" title="variable">x</span></a>).<br/>
<span class="id" title="keyword">Notation</span> <a id="Free.trigger" class="idref" href="#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> <span class="id" title="var">e</span> := (<a class="idref" href="Free.html#Free.trigger_"><span class="id" title="definition">trigger_</span></a> (<a class="idref" href="Free.html#Free.inject"><span class="id" title="definition">inject</span></a> <span class="id" title="var">e</span>)).<br/>
</div>

<div class="doc">
<a id="lab178"></a><h3 class="section">Putting it all together:</h3>

</div>
<div class="code">

<span class="id" title="keyword">Example</span> <a id="Free.e1" class="idref" href="#Free.e1"><span class="id" title="definition">e<sub>1</sub></span></a> : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> (<a class="idref" href="Free.html#Free.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#Free.BoolOp"><span class="id" title="inductive">BoolOp</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<a id="b:198" class="idref" href="#b:198"><span class="id" title="binder">b</span></a> <a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> (<a class="idref" href="Free.html#Free.or"><span class="id" title="constructor">or</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#true"><span class="id" title="constructor">true</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#false"><span class="id" title="constructor">false</span></a>)<a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;<span class="id" title="keyword">if</span> (<a class="idref" href="Free.html#b:198"><span class="id" title="variable">b</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#bool"><span class="id" title="inductive">bool</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">then</span> <a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> (<a class="idref" href="Free.html#Free.add"><span class="id" title="constructor">add</span></a> 10 10)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">else</span> <a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> (<a class="idref" href="Free.html#Free.add"><span class="id" title="constructor">add</span></a> 2 2).<br/><hr class='doublespaceincode'/>
<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#Free.fold_pure"><span class="id" title="definition">fold_pure</span></a> (<a class="idref" href="Free.html#Free.hpure_sum"><span class="id" title="definition">hpure_sum</span></a> <a class="idref" href="Free.html#Free.hplus"><span class="id" title="definition">hplus</span></a> <a class="idref" href="Free.html#Free.hbool"><span class="id" title="definition">hbool</span></a>) <a class="idref" href="Free.html#Free.e1"><span class="id" title="definition">e<sub>1</sub></span></a>.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">20</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> 
<div class="paragraph"> </div>

<a id="lab179"></a><h3 class="section">Recap:</h3>

<div class="paragraph"> </div>


<div class="paragraph"> </div>

<ul class="doclist">
<li> Use the <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> monad to define computations parameterized by "syntax" for operations like <span class="inlinecode"><span class="id" title="var">Plus</span></span>.

<div class="paragraph"> </div>


</li>
<li> Define the semantics of those operations separately using <i>handlers</i>


</li>
<li> Use <span class="inlinecode"><span class="id" title="var">fold_pure</span></span> as an <i>interpreter</i> to evaluate the handlers

</li>
</ul>

<div class="paragraph"> </div>

 Aside: Technically, <span class="inlinecode"><span class="id" title="var">FFree</span></span> <span class="inlinecode"><span class="id" title="var">E</span></span> is a <i>freer</i> monad, not the "Free" monad. 
<div class="paragraph"> </div>

<a id="lab180"></a><h3 class="section">Impure Interpretations</h3>

<div class="paragraph"> </div>

 Now imagine that we want to extend our language so that it manipulates a memory cell.
We can continue and follow our line of intuitions so far: we define the signature of
the operations interacting with this cell: one can either read it, or write to it.
Notice the different types of each operations:
<ul class="doclist">
<li> When reading, one expects to receive a <span class="inlinecode"><span class="id" title="var">nat</span></span> back

</li>
<li> When writing, all one expects is for the write to happen, the use does not wait for
    a meaningful answer: the return type is hence simply <span class="inlinecode"><span class="id" title="var">unit</span></span>.

</li>
</ul>

</div>
<div class="code">

<span class="id" title="keyword">Inductive</span> <a id="Free.Cell" class="idref" href="#Free.Cell"><span class="id" title="definition, inductive"><span id="Free.Cell_rect" class="id"><span id="Free.Cell_ind" class="id"><span id="Free.Cell_rec" class="id"><span id="Free.Cell_sind" class="id">Cell</span></span></span></span></span></a> : <span class="id" title="keyword">Type</span> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="keyword">Type</span> :=<br/>
| <a id="Free.Rd" class="idref" href="#Free.Rd"><span class="id" title="constructor">Rd</span></a> : <a class="idref" href="Free.html#Cell:199"><span class="id" title="inductive">Cell</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a><br/>
| <a id="Free.Wr" class="idref" href="#Free.Wr"><span class="id" title="constructor">Wr</span></a> (<a id="n:201" class="idref" href="#n:201"><span class="id" title="binder">n</span></a> : <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a>) : <a class="idref" href="Free.html#Cell:199"><span class="id" title="inductive">Cell</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#unit"><span class="id" title="inductive">unit</span></a>.<br/>
</div>

<div class="doc">
We can, of course, write computations much in the same way as before over
this signature, and combine it with the previous ones if we wish so.  
</div>
<div class="code">

<span class="id" title="keyword">Example</span> <a id="Free.double" class="idref" href="#Free.double"><span class="id" title="definition">double</span></a> : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> (<a class="idref" href="Free.html#Free.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#2c3369f05bd69871759ee07195700b<sub>20</sub>"><span class="id" title="notation">+'</span></a> <a class="idref" href="Free.html#Free.Cell"><span class="id" title="inductive">Cell</span></a>) <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#unit"><span class="id" title="inductive">unit</span></a> :=<br/>
&nbsp;&nbsp;<a id="x:202" class="idref" href="#x:202"><span class="id" title="binder">x</span></a>  <a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> <a class="idref" href="Free.html#Free.Rd"><span class="id" title="constructor">Rd</span></a><a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;<a id="xx:203" class="idref" href="#xx:203"><span class="id" title="binder">xx</span></a> <a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> (<a class="idref" href="Free.html#Free.add"><span class="id" title="constructor">add</span></a> <a class="idref" href="Free.html#x:202"><span class="id" title="variable">x</span></a> <a class="idref" href="Free.html#x:202"><span class="id" title="variable">x</span></a>)<a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">;;</span></a><br/>
&nbsp;&nbsp;<a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> (<a class="idref" href="Free.html#Free.Wr"><span class="id" title="constructor">Wr</span></a> <a class="idref" href="Free.html#xx:203"><span class="id" title="variable">xx</span></a>).<br/>
</div>

<div class="doc">
However, we are stuck when it comes to implement our Cell operations.
    The <span class="inlinecode"><span class="id" title="var">fold_pure</span></span> function is expecting us to essentially provide two functions:

<div class="paragraph"> </div>

<ul class="doclist">
<li> h_read  : nat

<div class="paragraph"> </div>


</li>
<li> h_write : nat <span class="nowrap"><span style='font-size:85%;'><span style='vertical-align:5%;'><span style='letter-spacing:-.2em;'>-</span></span>&gt;</span></span> unit

</li>
</ul>
  But this seems nonsensical: we need access to the cell itself in order to
implement these operations. This comes from the fact that we are now seeking to
model an <i>impure</i> operations: we will bring monads to the rescue to do so.  
<div class="paragraph"> </div>

<a id="lab181"></a><h3 class="section">Monadic <span class="inlinecode"><span class="id" title="tactic">fold</span></span>, or Monadic Interpreters</h3>

<div class="paragraph"> </div>

 First: some handy notation for "polymorphic" functions: 
</div>
<div class="code">
<span class="id" title="keyword">Notation</span> <a id="81c769233b17219a159b479baf5d11b<sub>3</sub>" class="idref" href="#81c769233b17219a159b479baf5d11b<sub>3</sub>"><span class="id" title="notation">&quot;</span></a>E ~&gt; F" := (<span class="id" title="keyword">∀</span> <a id="X:204" class="idref" href="#X:204"><span class="id" title="binder">X</span></a>, <span class="id" title="var">E</span> <a class="idref" href="Free.html#X:204"><span class="id" title="variable">X</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Logic.html#::type_scope:x_'-&gt;'_x"><span class="id" title="notation">→</span></a> <span class="id" title="var">F</span> <a class="idref" href="Free.html#X:204"><span class="id" title="variable">X</span></a>) (<span class="id" title="tactic">at</span> <span class="id" title="keyword">level</span> 30).<br/>
</div>

<div class="doc">
We can now redefine our folding function over monadic implementations of our effects 
</div>
<div class="code">

<span class="id" title="keyword">Fixpoint</span> <a id="Free.fold" class="idref" href="#Free.fold"><span class="id" title="definition">fold</span></a> {<a id="E:205" class="idref" href="#E:205"><span class="id" title="binder">E</span></a> <a id="M:206" class="idref" href="#M:206"><span class="id" title="binder">M</span></a>} `{<a id="H:207" class="idref" href="#H:207"><span class="id" title="binder">Monad</span></a> <a id="H:207" class="idref" href="#H:207"><span class="id" title="binder">M</span></a>} (<a id="h:208" class="idref" href="#h:208"><span class="id" title="binder">h</span></a> : <a class="idref" href="Free.html#E:205"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#81c769233b17219a159b479baf5d11b<sub>3</sub>"><span class="id" title="notation">~&gt;</span></a> <a class="idref" href="Free.html#M:206"><span class="id" title="variable">M</span></a>) [<a id="R:209" class="idref" href="#R:209"><span class="id" title="binder">R</span></a>] (<a id="t:210" class="idref" href="#t:210"><span class="id" title="binder">t</span></a> : <a class="idref" href="Free.html#Free.FFree"><span class="id" title="inductive">FFree</span></a> <a class="idref" href="Free.html#E:205"><span class="id" title="variable">E</span></a> <a class="idref" href="Free.html#R:209"><span class="id" title="variable">R</span></a>) : <a class="idref" href="Free.html#M:206"><span class="id" title="variable">M</span></a> <a class="idref" href="Free.html#R:209"><span class="id" title="variable">R</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#t:210"><span class="id" title="variable">t</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Ret"><span class="id" title="constructor">Ret</span></a> <span class="id" title="var">x</span> ⇒ <a class="idref" href="Monads.html#Monad.ret"><span class="id" title="method">ret</span></a> <span class="id" title="var">x</span><br/>
&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Do"><span class="id" title="constructor">Do</span></a> <span class="id" title="var">op</span> <span class="id" title="var">k</span> ⇒ <a id="x:213" class="idref" href="#x:213"><span class="id" title="binder">x</span></a> <a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">&lt;-</span></a> <a class="idref" href="Free.html#h:208"><span class="id" title="variable">h</span></a> <span class="id" title="var">_</span> <span class="id" title="var">op</span><a class="idref" href="Monads.html#3786188b3014de23a57c889c5f8409fc"><span class="id" title="notation">;;</span></a> <a class="idref" href="Free.html#fold:211"><span class="id" title="definition">fold</span></a> <a class="idref" href="Free.html#h:208"><span class="id" title="variable">h</span></a> (<span class="id" title="var">k</span> <a class="idref" href="Free.html#x:213"><span class="id" title="variable">x</span></a>)<br/>
&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
The type of this handler returns a computation in the <span class="inlinecode"><span class="id" title="var">state</span></span> monad: 
</div>
<div class="code">
<span class="id" title="keyword">Definition</span> <a id="Free.hcell" class="idref" href="#Free.hcell"><span class="id" title="definition">hcell</span></a> : <a class="idref" href="Free.html#Free.Cell"><span class="id" title="inductive">Cell</span></a> <a class="idref" href="Free.html#81c769233b17219a159b479baf5d11b<sub>3</sub>"><span class="id" title="notation">~&gt;</span></a> <a class="idref" href="Monads.html#Monad.state"><span class="id" title="definition">state</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <a id="e:214" class="idref" href="#e:214"><span class="id" title="binder">e</span></a> ⇒<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">match</span> <a class="idref" href="Free.html#e:214"><span class="id" title="variable">e</span></a> <span class="id" title="keyword">with</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Wr"><span class="id" title="constructor">Wr</span></a> <span class="id" title="var">n</span> ⇒ <a class="idref" href="Monads.html#Monad.put"><span class="id" title="definition">put</span></a> <span class="id" title="var">n</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;| <a class="idref" href="Free.html#Free.Rd"><span class="id" title="constructor">Rd</span></a>   ⇒ <a class="idref" href="Monads.html#Monad.get"><span class="id" title="definition">get</span></a><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id" title="keyword">end</span>.<br/>
</div>

<div class="doc">
Intuitively, this means that we can <i>interpret</i> the operations <span class="inlinecode"><span class="id" title="var">Wr</span></span> and <span class="inlinecode"><span class="id" title="var">Rd</span></span>
by their semantic counterpart. 
<div class="paragraph"> </div>

<a id="lab182"></a><h3 class="section">Lifting computations</h3>
 We do have to <i>lift</i> the pure handler <span class="inlinecode"><span class="id" title="var">hplus</span></span> into the <span class="inlinecode"><span class="id" title="var">state</span></span> monad. 
<div class="paragraph"> </div>

 But, this can be alleviated with an additional piece of technology that we will introduce later. 
</div>
<div class="code">

<span class="id" title="keyword">Definition</span> <a id="Free.hplusS" class="idref" href="#Free.hplusS"><span class="id" title="definition">hplusS</span></a> : <a class="idref" href="Free.html#Free.Plus"><span class="id" title="inductive">Plus</span></a> <a class="idref" href="Free.html#81c769233b17219a159b479baf5d11b<sub>3</sub>"><span class="id" title="notation">~&gt;</span></a> <a class="idref" href="Monads.html#Monad.state"><span class="id" title="definition">state</span></a> <a class="idref" href="http://coq.inria.fr/library//Coq.Init.Datatypes.html#nat"><span class="id" title="inductive">nat</span></a> :=<br/>
&nbsp;&nbsp;<span class="id" title="keyword">fun</span> <span class="id" title="var">_</span> <a id="e:216" class="idref" href="#e:216"><span class="id" title="binder">e</span></a> ⇒ <a class="idref" href="Monads.html#Monad.ret"><span class="id" title="method">ret</span></a> (<a class="idref" href="Free.html#Free.hplus"><span class="id" title="definition">hplus</span></a> <span class="id" title="var">_</span> <a class="idref" href="Free.html#e:216"><span class="id" title="variable">e</span></a>).<br/><hr class='doublespaceincode'/>
</div>

<div class="doc">
 Recalling our example from earlier:
<br/>
<span class="inlinecode"><span class="id" title="keyword">Example</span> <span class="id" title="var">double</span> : <span class="id" title="var">FFree</span> (<span class="id" title="var">Plus</span> +' <span class="id" title="var">Cell</span>) <span class="id" title="var">unit</span> :=<br/>
&nbsp;&nbsp;<span class="id" title="var">x</span>  &lt;- <span class="id" title="var">trigger</span> <span class="id" title="var">Rd</span>;;<br/>
&nbsp;&nbsp;<span class="id" title="var">xx</span> &lt;- <span class="id" title="var">trigger</span> (<span class="id" title="var">add</span> <span class="id" title="var">x</span> <span class="id" title="var">x</span>);;<br/>
&nbsp;&nbsp;<span class="id" title="var">trigger</span> (<span class="id" title="var">Wr</span> <span class="id" title="var">xx</span>).
</span>
<div class="paragraph"> </div>

 We can now run it in the <span class="inlinecode"><span class="id" title="var">state</span></span> monad: 
</div>
<div class="code">

<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> <a class="idref" href="Free.html#Free.fold"><span class="id" title="definition">fold</span></a> (<a class="idref" href="Free.html#Free.hplusS"><span class="id" title="definition">hplusS</span></a> <a class="idref" href="Free.html#a93f78c566df924d996ee814e77ae5ae"><span class="id" title="notation">⊕</span></a> <a class="idref" href="Free.html#Free.hcell"><span class="id" title="definition">hcell</span></a>) <a class="idref" href="Free.html#Free.double"><span class="id" title="definition">double</span></a> 16.<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">(32,</span> <span class="inlinecode"><span class="id" title="var">tt</span>)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> <span class="inlinecode">×</span> <span class="inlinecode"><span class="id" title="var">unit</span></span> 
</div>
<div class="code">

<span class="id" title="keyword">Eval</span> <span class="id" title="tactic">compute</span> <span class="id" title="keyword">in</span> (<a class="idref" href="Free.html#Free.fold"><span class="id" title="definition">fold</span></a> (<a class="idref" href="Free.html#Free.hplusS"><span class="id" title="definition">hplusS</span></a> <a class="idref" href="Free.html#a93f78c566df924d996ee814e77ae5ae"><span class="id" title="notation">⊕</span></a> <a class="idref" href="Free.html#Free.hcell"><span class="id" title="definition">hcell</span></a>) (<a class="idref" href="Free.html#Free.double"><span class="id" title="definition">double</span></a> <a class="idref" href="Monads.html#1da0769dc49b3c22924058237ab38059"><span class="id" title="notation">;;</span></a> <a class="idref" href="Free.html#Free.trigger"><span class="id" title="abbreviation">trigger</span></a> <a class="idref" href="Free.html#Free.Rd"><span class="id" title="constructor">Rd</span></a>) 42).<br/>
</div>

<div class="doc">
==&gt; <span class="inlinecode">(84,</span> <span class="inlinecode">84)</span> <span class="inlinecode">:</span> <span class="inlinecode"><span class="id" title="var">nat</span></span> <span class="inlinecode">×</span> <span class="inlinecode"><span class="id" title="var">unit</span></span> 
</div>

<div class="doc">
<a id="lab183"></a><h2 class="section">Next: <span class="inlinecode"><span class="id" title="var">ITrees</span></span></h2>

<div class="paragraph"> </div>

 At this point, are we ready to tackle  <span class="inlinecode"><span class="id" title="var">ITrees</span></span> 
</div>
<div class="code">

<span class="comment">(*&nbsp;2024-06-07&nbsp;10:32&nbsp;*)</span><br/>
</div>
</div>

<div id="footer">
<hr/><a href="coqindex.html">Index</a><hr/>This page has been generated by <a href="http://coq.inria.fr/">coqdoc</a>
</div>

</div>

</body>
</html>